import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta
import json
import random
import numpy as np
from pathlib import Path
import os

# 1. é¡µé¢é…ç½® (å¿…é¡»åœ¨ç¬¬ä¸€è¡Œ)
st.set_page_config(
    page_title="ä¸‰è§’æ´²æˆ˜æœ¯ç»ˆç«¯ v4.0", 
    page_icon="ğŸ¯",
    layout="wide", 
    initial_sidebar_state="expanded"
)

# 2. è‡ªå®šä¹‰æ ·å¼
st.markdown("""
<style>
#MainMenu {visibility: hidden;}
header {visibility: hidden;}
footer {visibility: hidden;}
.block-container {padding-top: 1rem; padding-left: 1rem; padding-right: 1rem;}
.stat-card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 1.5rem;
    border-radius: 15px;
    border: 1px solid #333;
    margin-bottom: 1rem;
}
.highlight {
    color: #FFD700;
    font-weight: bold;
}
.map-card {
    background: #1e1e2e;
    border-radius: 10px;
    padding: 1rem;
    border: 1px solid #444;
    transition: all 0.3s;
}
.map-card:hover {
    border-color: #FFD700;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
}
</style>
""", unsafe_allow_html=True)

# ==================== æ•°æ®å®šä¹‰ ====================

# åœ°å›¾åˆ—è¡¨
MAP_LIST = ["å¤§å", "é•¿å¼“", "å·´å…‹ä»€", "èˆªå¤©", "ç›‘ç‹±"]

# æ¯ä¸ªåœ°å›¾å¯é€‰çš„æ¨¡å¼
MAP_MODES = {
    "å¤§å": ["æ™®é€š", "æœºå¯†"],
    "é•¿å¼“": ["æ™®é€š", "æœºå¯†"],
    "å·´å…‹ä»€": ["æœºå¯†", "ç»å¯†"],
    "èˆªå¤©": ["æœºå¯†", "ç»å¯†"],
    "ç›‘ç‹±": ["ç»å¯†", "è‡ªé€‚åº”"],
}

# åœ°å›¾åŸºç¡€ä¿¡æ¯
MAPS_DATA = {
    "å¤§å": {
        "description": "å¤§ååœ°å›¾ï¼Œç»å…¸æœæ‰“æ’¤åœ°å›¾ï¼Œå¤šå±‚å»ºç­‘ç»“æ„",
        "size": "ä¸­å‹",
        "player_count": "12äºº",
        "difficulty": "ä¸­ç­‰",
        "loot_zones": ["ä¼šè®®åŒºåŸŸ", "å¹³å·", "é’¢é“å¡”", "ç‹¼ç‰™", "é›·è¾¾ç«™", "é‡‘èåœ°å—", "æµ·å†›ä¸­å¿ƒ"],
        "spawn_points": {
            "ä¼˜åŠ¿æ–¹": [
                {"name": "å†›è¥/æ æ†", "desc": "ç¦»ä¸»æ¥¼æœ€è¿‘ï¼ŒTOå‡ºç”Ÿç‚¹", "strategy": "å¿«é€Ÿå†²ä¸»æ¥¼ï¼ŒæŠ¢å å…ˆæœº", "risk": "ä¸­ç­‰"},
                {"name": "ç»´ä¿®é€šé“", "desc": "å¸¦ç”µé€šè¿‡æ²³æˆ–è¿›é“", "strategy": "ç»•åå·è¢­ï¼Œé¿å¼€æ­£é¢", "risk": "è¾ƒé«˜"},
                {"name": "å˜ç”µç«™å¤–å›´", "desc": "é€šå¸¸å…ˆåƒå˜ç”µç«™å†å»æ¥¼", "strategy": "ç¨³å¥å‘è‚²åè¿›æ”»", "risk": "è¾ƒä½"}
            ],
            "åŠ£åŠ¿æ–¹": [
                {"name": "æµèˆä¸­å¿ƒæ­£é—¨", "desc": "å…¨å›¾æœ€è¿œï¼Œéœ€é•¿é€”å¥”è¢­", "strategy": "å¿«é€Ÿç§»åŠ¨ï¼Œé¿å…è¢«æˆª", "risk": "é«˜"},
                {"name": "æ°´æ³¥å‚/åå±±", "desc": "å»ºè®®ç›´æ¥åƒå®Œæ°´æ³¥å‚ï¼Œæ¶èµ·å‰å¾€ä¸­å¿ƒçš„äºº", "strategy": "å…ˆæœåˆ®å†ä¼å‡»", "risk": "ä¸­ç­‰"},
                {"name": "æ²³æ»©/é‡åœ°", "desc": "è€å…­ä½ï¼Œé€‚åˆåŠè·¯æˆªæ€", "strategy": "åŸ‹ä¼æ‰“æ¸¸å‡»", "risk": "é«˜"}
            ]
        },
        "hot_zones": [
            {"name": "ä¼šè®®åŒºåŸŸ", "value": "é«˜", "items": ["é’¥åŒ™å¡", "é«˜çº§è£…å¤‡"], "danger": "æé«˜"},
            {"name": "é‡‘èåœ°å—", "value": "æé«˜", "items": ["ç°é‡‘", "æƒ…æŠ¥æ–‡ä»¶"], "danger": "æé«˜"},
            {"name": "æµ·å†›ä¸­å¿ƒ", "value": "é«˜", "items": ["å†›ç”¨ç‰©èµ„", "åŒ»ç–—åŒ…"], "danger": "é«˜"}
        ],
        "extract_points": [
            {"name": "E1åŒ—éƒ¨æ’¤ç¦»ç‚¹", "location": "åœ°å›¾åŒ—ä¾§", "distance": "è¿‘", "risk": "ä¸­ç­‰"},
            {"name": "E2ä¸œéƒ¨æ’¤ç¦»ç‚¹", "location": "åœ°å›¾ä¸œä¾§", "distance": "ä¸­", "risk": "è¾ƒä½"},
            {"name": "E3å—éƒ¨æ’¤ç¦»ç‚¹", "location": "åœ°å›¾å—ä¾§", "distance": "è¿œ", "risk": "è¾ƒé«˜"},
            {"name": "E4è¥¿éƒ¨æ’¤ç¦»ç‚¹", "location": "åœ°å›¾è¥¿ä¾§", "distance": "ä¸­", "risk": "ä¸­ç­‰"}
        ],
        "tactical_routes": [
            {"name": "é€Ÿæ”»è·¯çº¿", "path": "å†›è¥â†’ä¼šè®®åŒºåŸŸâ†’é‡‘èåœ°å—â†’E1æ’¤ç¦»", "time": "8-12åˆ†é’Ÿ", "profit": "é«˜"},
            {"name": "ç¨³å¥è·¯çº¿", "path": "å˜ç”µç«™â†’é›·è¾¾ç«™â†’å¹³å·â†’E2æ’¤ç¦»", "time": "12-15åˆ†é’Ÿ", "profit": "ä¸­ç­‰"},
            {"name": "ç»•åè·¯çº¿", "path": "æ°´æ³¥å‚â†’æ²³æ»©â†’æµ·å†›ä¸­å¿ƒâ†’E4æ’¤ç¦»", "time": "10-14åˆ†é’Ÿ", "profit": "ä¸­é«˜"}
        ],
        "tips": [
            "ğŸ’¡ ä¼šè®®åŒºåŸŸå’Œé‡‘èåœ°å—æ˜¯å¿…äº‰ä¹‹åœ°ï¼Œå»ºè®®ç»„é˜Ÿè¡ŒåŠ¨",
            "âš ï¸ ä¸»æ¥¼å‘¨å›´è§†é‡å¼€é˜”ï¼Œå®¹æ˜“è¢«ç‹™å‡»æ‰‹ç›¯ä¸Š",
            "ğŸ¯ å˜ç”µç«™è£…å¤‡ä¸°å¯Œä¸”ç›¸å¯¹å®‰å…¨ï¼Œé€‚åˆå‰æœŸå‘è‚²",
            "ğŸš æ’¤ç¦»å‰æ£€æŸ¥å‘¨å›´ï¼Œé¿å…è¢«è¹²å®ˆ"
        ]
    },
    "é•¿å¼“": {
        "description": "æ£®æ—åœ°å›¾ï¼Œåœ°å½¢å¤æ‚ï¼Œé€‚åˆä¸­è¿œè·ç¦»ä½œæˆ˜",
        "size": "å¤§å‹",
        "player_count": "14äºº",
        "difficulty": "ä¸­ç­‰",
        "loot_zones": ["æ—ä¸­å°å±‹", "ç­æœ›å¡”", "è¥åœ°", "æºªæµ", "ä¼æœ¨åœº", "çŒäººå°å±‹"],
        "spawn_points": {
            "éšæœºå‡ºç”Ÿ": [
                {"name": "æ—ä¸­å°å±‹", "desc": "æ£®æ—è¾¹ç¼˜", "strategy": "å¿«é€Ÿæœåˆ®æ’¤ç¦»", "risk": "ä½"},
                {"name": "ç­æœ›å¡”", "desc": "åˆ¶é«˜ç‚¹", "strategy": "è§‚å¯Ÿåå†³ç­–", "risk": "ä¸­ç­‰"},
                {"name": "è¥åœ°", "desc": "ä¸­å¿ƒåŒºåŸŸ", "strategy": "æŠ¢å èµ„æº", "risk": "é«˜"}
            ]
        },
        "hot_zones": [
            {"name": "è¥åœ°", "value": "æé«˜", "items": ["å†›ç”¨è¡¥ç»™ç®±"], "danger": "æé«˜"},
            {"name": "ä¼æœ¨åœº", "value": "é«˜", "items": ["å·¥å…·ç®±", "å¼¹è¯"], "danger": "é«˜"}
        ],
        "extract_points": [
            {"name": "æ£®æ—è¾¹ç¼˜", "location": "åœ°å›¾è¾¹ç•Œ", "distance": "è¿œ", "risk": "ä½"},
            {"name": "å°è·¯", "location": "æ£®æ—å°å¾„", "distance": "ä¸­", "risk": "ä¸­ç­‰"},
            {"name": "æ²³æµ", "location": "æ²³æµæ¸¡å£", "distance": "è¿‘", "risk": "è¾ƒé«˜"}
        ],
        "tactical_routes": [
            {"name": "å¤–å›´æœåˆ®", "path": "è¾¹ç¼˜å°å±‹â†’çŒäººå°å±‹â†’æ£®æ—è¾¹ç¼˜æ’¤ç¦»", "time": "10-12åˆ†é’Ÿ", "profit": "ä¸­ç­‰"},
            {"name": "ä¸­å¿ƒäº‰å¤º", "path": "è¥åœ°â†’ä¼æœ¨åœºâ†’æ²³æµæ’¤ç¦»", "time": "8-10åˆ†é’Ÿ", "profit": "é«˜"}
        ],
        "tips": [
            "ğŸ’¡ æ£®æ—è§†çº¿å—é˜»ï¼Œæ³¨æ„ä½¿ç”¨å£°éŸ³å®šä½",
            "âš ï¸ è¥åœ°æ˜¯å¿…äº‰ä¹‹åœ°ï¼Œå‡†å¤‡å¥½æˆ˜æ–—",
            "ğŸ¯ ç­æœ›å¡”å¯ä»¥è§‚å¯Ÿå¤§åŠä¸ªåœ°å›¾"
        ]
    },
    "å·´å…‹ä»€": {
        "description": "æ²™æ¼ åœ°å›¾ï¼Œå¼€é˜”åœ°å½¢ï¼Œè¿œè·ç¦»ç‹™å‡»ä¸ºä¸»",
        "size": "å¤§å‹",
        "player_count": "16äºº",
        "difficulty": "å›°éš¾",
        "loot_zones": ["æ¸…çœŸå¯º", "é›†å¸‚", "å†›è¥", "æ²¹ç”°", "åºŸå¢Ÿ", "å ¡å’"],
        "spawn_points": {
            "éšæœºå‡ºç”Ÿ": [
                {"name": "æ¸…çœŸå¯º", "desc": "åŸé•‡ä¸­å¿ƒ", "strategy": "å¿«é€Ÿè¿›å…¥å»ºç­‘", "risk": "ä¸­ç­‰"},
                {"name": "æ²¹ç”°", "desc": "èµ„æºç‚¹", "strategy": "æœåˆ®å·¥ä¸šç‰©èµ„", "risk": "é«˜"},
                {"name": "åºŸå¢Ÿ", "desc": "è¾¹ç¼˜åœ°å¸¦", "strategy": "éšè”½å‘è‚²", "risk": "ä½"}
            ]
        },
        "hot_zones": [
            {"name": "å†›è¥", "value": "æé«˜", "items": ["å†›ç”¨è£…å¤‡", "å¼¹è¯ç®±"], "danger": "æé«˜"},
            {"name": "å ¡å’", "value": "é«˜", "items": ["é«˜çº§é˜²å…·", "æ­¦å™¨é…ä»¶"], "danger": "é«˜"}
        ],
        "extract_points": [
            {"name": "æ²™æ¼ è¾¹ç¼˜", "location": "åœ°å›¾å¤–å›´", "distance": "è¿œ", "risk": "ä½"},
            {"name": "ç›´å‡æœº", "location": "åœæœºåª", "distance": "ä¸­", "risk": "é«˜"},
            {"name": "è½¦é˜Ÿ", "location": "å…¬è·¯", "distance": "è¿‘", "risk": "ä¸­ç­‰"}
        ],
        "tactical_routes": [
            {"name": "ç‹™å‡»è·¯çº¿", "path": "åºŸå¢Ÿåˆ¶é«˜ç‚¹â†’è¿œç¨‹ç‹™å‡»â†’æ²™æ¼ è¾¹ç¼˜", "time": "12-15åˆ†é’Ÿ", "profit": "ä¸­ç­‰"},
            {"name": "å†²é”‹è·¯çº¿", "path": "æ¸…çœŸå¯ºâ†’å†›è¥â†’å ¡å’â†’ç›´å‡æœº", "time": "8-12åˆ†é’Ÿ", "profit": "æé«˜"}
        ],
        "tips": [
            "ğŸ’¡ å¼€é˜”åœ°å½¢ï¼Œç§»åŠ¨æ—¶æ³¨æ„å¯»æ‰¾æ©ä½“",
            "âš ï¸ ç‹™å‡»æ‰‹å¤©å ‚ï¼Œæºå¸¦è¿œç¨‹æ­¦å™¨",
            "ğŸ¯ å†›è¥å’Œå ¡å’å¿…æœ‰æ¿€æˆ˜"
        ]
    },
    "èˆªå¤©": {
        "description": "èˆªå¤©ä¸­å¿ƒåœ°å›¾ï¼Œç§‘æŠ€æ„Ÿåè¶³ï¼Œå¤šå±‚å»ºç­‘",
        "size": "å¤§å‹",
        "player_count": "14äºº",
        "difficulty": "å›°éš¾",
        "loot_zones": ["å‘å°„å°", "æ§åˆ¶ä¸­å¿ƒ", "ç ”ç©¶æ‰€", "ä»“å‚¨åŒº", "åœæœºåª", "åœ°ä¸‹è®¾æ–½"],
        "spawn_points": {
            "éšæœºå‡ºç”Ÿ": [
                {"name": "å‘å°„å°", "desc": "å¼€é˜”åŒºåŸŸ", "strategy": "å¿«é€Ÿè½¬ç§»", "risk": "é«˜"},
                {"name": "ä»“å‚¨åŒº", "desc": "ç‰©èµ„ä¸°å¯Œ", "strategy": "æœåˆ®å‘è‚²", "risk": "ä¸­ç­‰"},
                {"name": "åœ°ä¸‹è®¾æ–½", "desc": "å¤æ‚åœ°å½¢", "strategy": "CQBä½œæˆ˜", "risk": "é«˜"}
            ]
        },
        "hot_zones": [
            {"name": "æ§åˆ¶ä¸­å¿ƒ", "value": "æé«˜", "items": ["æƒ…æŠ¥æ–‡ä»¶", "é’¥åŒ™å¡"], "danger": "æé«˜"},
            {"name": "ç ”ç©¶æ‰€", "value": "æé«˜", "items": ["å®éªŒè£…å¤‡", "åŒ»ç–—ç”¨å“"], "danger": "é«˜"}
        ],
        "extract_points": [
            {"name": "ç›´å‡æœº", "location": "åœæœºåª", "distance": "ä¸­", "risk": "é«˜"},
            {"name": "ç´§æ€¥é€šé“", "location": "åœ°ä¸‹å‡ºå£", "distance": "è¿‘", "risk": "ä¸­ç­‰"},
            {"name": "åœè½¦åœº", "location": "åœ°é¢å‡ºå£", "distance": "è¿œ", "risk": "ä½"}
        ],
        "tactical_routes": [
            {"name": "ç§‘æŠ€è·¯çº¿", "path": "ç ”ç©¶æ‰€â†’æ§åˆ¶ä¸­å¿ƒâ†’ç›´å‡æœº", "time": "10-14åˆ†é’Ÿ", "profit": "æé«˜"},
            {"name": "åœ°ä¸‹è·¯çº¿", "path": "åœ°ä¸‹è®¾æ–½â†’ä»“å‚¨åŒºâ†’ç´§æ€¥é€šé“", "time": "8-12åˆ†é’Ÿ", "profit": "ä¸­é«˜"}
        ],
        "tips": [
            "ğŸ’¡ å¤šå±‚å»ºç­‘ï¼Œæ³¨æ„å‚ç›´æ–¹å‘çš„æ•Œäºº",
            "âš ï¸ æ§åˆ¶ä¸­å¿ƒå¿…æœ‰æ¿€æˆ˜ï¼Œåšå¥½å‡†å¤‡",
            "ğŸ¯ åœ°ä¸‹è®¾æ–½é€‚åˆè¿‘æˆ˜æ­¦å™¨"
        ]
    },
    "ç›‘ç‹±": {
        "description": "ç›‘ç‹±åœ°å›¾ï¼ŒCQBä¸ºä¸»ï¼Œè¿‘è·ç¦»äº¤æˆ˜é¢‘ç¹",
        "size": "ä¸­å‹",
        "player_count": "12äºº",
        "difficulty": "å›°éš¾",
        "loot_zones": ["ç‰¢æˆ¿åŒº", "é£Ÿå ‚", "æ“åœº", "åŒ»åŠ¡å®¤", "ç›‘æ§å®¤", "åœ°ä¸‹é€šé“"],
        "spawn_points": {
            "éšæœºå‡ºç”Ÿ": [
                {"name": "ç‰¢æˆ¿åŒº", "desc": "ç‹­çª„ç©ºé—´", "strategy": "CQBæˆ˜æ–—", "risk": "æé«˜"},
                {"name": "æ“åœº", "desc": "å¼€é˜”åŒºåŸŸ", "strategy": "å¿«é€Ÿç§»åŠ¨", "risk": "é«˜"},
                {"name": "åœ°ä¸‹é€šé“", "desc": "éšè”½è·¯çº¿", "strategy": "ç»•åå·è¢­", "risk": "ä¸­ç­‰"}
            ]
        },
        "hot_zones": [
            {"name": "ç›‘æ§å®¤", "value": "æé«˜", "items": ["ç”µå­è®¾å¤‡", "é’¥åŒ™å¡"], "danger": "æé«˜"},
            {"name": "åŒ»åŠ¡å®¤", "value": "é«˜", "items": ["åŒ»ç–—ç”¨å“", "è¯å“"], "danger": "é«˜"}
        ],
        "extract_points": [
            {"name": "æ­£é—¨", "location": "ä¸»å…¥å£", "distance": "è¿‘", "risk": "æé«˜"},
            {"name": "åé—¨", "location": "åæ–¹å‡ºå£", "distance": "ä¸­", "risk": "ä¸­ç­‰"},
            {"name": "ä¸‹æ°´é“", "location": "åœ°ä¸‹å‡ºå£", "distance": "è¿œ", "risk": "ä½"}
        ],
        "tactical_routes": [
            {"name": "é€Ÿæˆ˜é€Ÿå†³", "path": "ç›‘æ§å®¤â†’åŒ»åŠ¡å®¤â†’åé—¨", "time": "6-10åˆ†é’Ÿ", "profit": "é«˜"},
            {"name": "åœ°ä¸‹æ½œè¡Œ", "path": "åœ°ä¸‹é€šé“â†’ç‰¢æˆ¿åŒºâ†’ä¸‹æ°´é“", "time": "8-12åˆ†é’Ÿ", "profit": "ä¸­ç­‰"}
        ],
        "tips": [
            "ğŸ’¡ è¿‘è·ç¦»æˆ˜æ–—ä¸ºä¸»ï¼Œæºå¸¦éœ°å¼¹æªæˆ–å†²é”‹æª",
            "âš ï¸ ç›‘æ§å®¤æ˜¯å¿…äº‰ä¹‹åœ°ï¼Œå‡†å¤‡é—ªå…‰å¼¹",
            "ğŸ¯ åœ°ä¸‹é€šé“å¯ä»¥é¿å¼€å¤§éƒ¨åˆ†æˆ˜æ–—"
        ]
    },
}

# æ¨¡å¼éš¾åº¦ä¿¡æ¯
MODE_INFO = {
    "æ™®é€š": {"difficulty": "ç®€å•", "player_count": "8-12äºº", "loot_modifier": 1.0},
    "æœºå¯†": {"difficulty": "ä¸­ç­‰", "player_count": "10-14äºº", "loot_modifier": 1.5},
    "ç»å¯†": {"difficulty": "å›°éš¾", "player_count": "12-16äºº", "loot_modifier": 2.0},
    "è‡ªé€‚åº”": {"difficulty": "åŠ¨æ€", "player_count": "10-14äºº", "loot_modifier": 1.8},
}

# åŸºç¡€å‡ºè´§æ¦‚ç‡ (ä¼šæ ¹æ®æ¨¡å¼å€ç‡è°ƒæ•´)
BASE_LOOT_PROBABILITY = {
    "å¤§å": {
        "é«˜çº§æ­¦å™¨": 10, "ä¸­çº§æ­¦å™¨": 30, "ä½çº§æ­¦å™¨": 60,
        "é«˜çº§æŠ¤ç”²": 8, "ä¸­çº§æŠ¤ç”²": 25, "ä½çº§æŠ¤ç”²": 45,
        "åŒ»ç–—ç‰©èµ„": 50, "å¼¹è¯": 85, "é’¥åŒ™å¡": 3, "æƒ…æŠ¥æ–‡ä»¶": 4,
    },
    "é•¿å¼“": {
        "é«˜çº§æ­¦å™¨": 12, "ä¸­çº§æ­¦å™¨": 32, "ä½çº§æ­¦å™¨": 56,
        "é«˜çº§æŠ¤ç”²": 9, "ä¸­çº§æŠ¤ç”²": 27, "ä½çº§æŠ¤ç”²": 42,
        "åŒ»ç–—ç‰©èµ„": 48, "å¼¹è¯": 82, "é’¥åŒ™å¡": 4, "æƒ…æŠ¥æ–‡ä»¶": 5,
    },
    "å·´å…‹ä»€": {
        "é«˜çº§æ­¦å™¨": 15, "ä¸­çº§æ­¦å™¨": 35, "ä½çº§æ­¦å™¨": 50,
        "é«˜çº§æŠ¤ç”²": 12, "ä¸­çº§æŠ¤ç”²": 30, "ä½çº§æŠ¤ç”²": 40,
        "åŒ»ç–—ç‰©èµ„": 50, "å¼¹è¯": 80, "é’¥åŒ™å¡": 6, "æƒ…æŠ¥æ–‡ä»¶": 8,
    },
    "èˆªå¤©": {
        "é«˜çº§æ­¦å™¨": 18, "ä¸­çº§æ­¦å™¨": 38, "ä½çº§æ­¦å™¨": 44,
        "é«˜çº§æŠ¤ç”²": 15, "ä¸­çº§æŠ¤ç”²": 33, "ä½çº§æŠ¤ç”²": 38,
        "åŒ»ç–—ç‰©èµ„": 55, "å¼¹è¯": 75, "é’¥åŒ™å¡": 8, "æƒ…æŠ¥æ–‡ä»¶": 10,
    },
    "ç›‘ç‹±": {
        "é«˜çº§æ­¦å™¨": 16, "ä¸­çº§æ­¦å™¨": 36, "ä½çº§æ­¦å™¨": 48,
        "é«˜çº§æŠ¤ç”²": 13, "ä¸­çº§æŠ¤ç”²": 31, "ä½çº§æŠ¤ç”²": 40,
        "åŒ»ç–—ç‰©èµ„": 55, "å¼¹è¯": 78, "é’¥åŒ™å¡": 7, "æƒ…æŠ¥æ–‡ä»¶": 9,
    },
}

# æˆ˜å¤‡æ¨èæ•°æ® (æŒ‰åœ°å›¾)
LOADOUT_RECOMMENDATIONS = {
    "å¤§å": {
        "ä¸»æ­¦å™¨": ["M4A1", "AK-47", "HK416"],
        "å‰¯æ­¦å™¨": ["æ ¼æ´›å…‹18", "æ²™æ¼ ä¹‹é¹°"],
        "æ¨èé…ä»¶": ["4å€é•œ", "æ¶ˆéŸ³å™¨", "å‚ç›´æ¡æŠŠ", "æ‰©å®¹å¼¹åŒ£"],
        "å¿…å¸¦ç‰©èµ„": ["æ­¢è¡€å¸¦x3", "åŒ»ç–—åŒ…x1", "æ­¢ç—›è¯x2"],
        "æˆ˜æœ¯å»ºè®®": "æ§åˆ¶å®¤å’Œä»“åº“åŒºæ˜¯å¿…äº‰ä¹‹åœ°ã€‚æ³¨æ„æ°´é—¸åŒºåŸŸçš„ä¼å‡»ç‚¹ï¼Œå¤šå±‚å»ºç­‘æ¸…è§’è¦ä»”ç»†ã€‚",
    },
    "é•¿å¼“": {
        "ä¸»æ­¦å™¨": ["M4A1", "ç‹™å‡»æ­¥æª", "SCAR-H"],
        "å‰¯æ­¦å™¨": ["MP5", "æ ¼æ´›å…‹18"],
        "æ¨èé…ä»¶": ["4-8å€é•œ", "æ¶ˆéŸ³å™¨", "ä¸¤è„šæ¶", "æ‰©å®¹å¼¹åŒ£"],
        "å¿…å¸¦ç‰©èµ„": ["æ­¢è¡€å¸¦x2", "åŒ»ç–—åŒ…x1", "çƒŸé›¾å¼¹x2"],
        "æˆ˜æœ¯å»ºè®®": "æ£®æ—åœ°å›¾åˆ©ç”¨åœ°å½¢æ©æŠ¤ï¼Œè¥åœ°å’Œä¼æœ¨åœºç‰©èµ„é›†ä¸­ã€‚è¿œè¿‘ç»“åˆé…è£…æ›´ä½³ã€‚",
    },
    "å·´å…‹ä»€": {
        "ä¸»æ­¦å™¨": ["ç‹™å‡»æ­¥æª", "DMR", "SCAR-H"],
        "å‰¯æ­¦å™¨": ["M4A1", "MP5"],
        "æ¨èé…ä»¶": ["8å€é•œ", "æ¶ˆéŸ³å™¨", "ä¸¤è„šæ¶", "æ‰©å®¹å¼¹åŒ£"],
        "å¿…å¸¦ç‰©èµ„": ["æ­¢è¡€å¸¦x2", "åŒ»ç–—åŒ…x1", "çƒŸé›¾å¼¹x3"],
        "æˆ˜æœ¯å»ºè®®": "æ²™æ¼ å¼€é˜”åœ°å½¢ï¼Œç‹™å‡»ä¸ºä¸»ã€‚å†›è¥å’Œå ¡å’æ˜¯é«˜ä»·å€¼åŒºï¼Œåˆ©ç”¨çƒŸé›¾å¼¹è½¬ç§»ã€‚",
    },
    "èˆªå¤©": {
        "ä¸»æ­¦å™¨": ["HK416", "M4A1", "Vector"],
        "å‰¯æ­¦å™¨": ["MP7", "æ ¼æ´›å…‹18"],
        "æ¨èé…ä»¶": ["å…¨æ¯/çº¢ç‚¹ç„å…·", "æ¶ˆéŸ³å™¨", "æ¿€å…‰æŒ‡ç¤ºå™¨", "æ‰©å®¹å¼¹åŒ£"],
        "å¿…å¸¦ç‰©èµ„": ["æ­¢è¡€å¸¦x3", "åŒ»ç–—åŒ…x2", "é—ªå…‰å¼¹x2"],
        "æˆ˜æœ¯å»ºè®®": "æ§åˆ¶ä¸­å¿ƒå’Œç ”ç©¶æ‰€ç‰©èµ„ä¸°å¯Œï¼Œå¤šå±‚å»ºç­‘æ³¨æ„é«˜ä½å·®ã€‚æ¸…è§’è¦ä»”ç»†ã€‚",
    },
    "ç›‘ç‹±": {
        "ä¸»æ­¦å™¨": ["MP5", "P90", "Vector"],
        "å‰¯æ­¦å™¨": ["éœ°å¼¹æª", "æ ¼æ´›å…‹18"],
        "æ¨èé…ä»¶": ["çº¢ç‚¹ç„å…·", "æˆ˜æœ¯æ‰‹ç”µ", "æ¿€å…‰æŒ‡ç¤ºå™¨", "æ‰©å®¹å¼¹åŒ£"],
        "å¿…å¸¦ç‰©èµ„": ["æ­¢è¡€å¸¦x3", "åŒ»ç–—åŒ…x2", "é—ªå…‰å¼¹x2"],
        "æˆ˜æœ¯å»ºè®®": "CQBåœ°å›¾ï¼Œå†²é”‹æª/éœ°å¼¹æªä¸ºä¸»ã€‚ç›‘æ§å®¤å’ŒåŒ»åŠ¡å®¤æ˜¯é«˜ä»·å€¼åŒºï¼Œå¬è„šæ­¥å£°å¾ˆé‡è¦ã€‚",
    },
}

# æ¨¡å¼å¯¹åº”çš„æ¨èæŠ¤ç”²å’Œæˆæœ¬
MODE_LOADOUT = {
    "æ™®é€š": {"æ¨èæŠ¤ç”²": "3-4çº§é˜²å¼¹è¡£", "é£é™©ç­‰çº§": "ä½", "é¢„ä¼°æˆæœ¬": 60000},
    "æœºå¯†": {"æ¨èæŠ¤ç”²": "4-5çº§é˜²å¼¹è¡£ + å¤´ç›”", "é£é™©ç­‰çº§": "ä¸­", "é¢„ä¼°æˆæœ¬": 120000},
    "ç»å¯†": {"æ¨èæŠ¤ç”²": "5-6çº§é˜²å¼¹è¡£ + å¤´ç›”", "é£é™©ç­‰çº§": "æé«˜", "é¢„ä¼°æˆæœ¬": 220000},
    "è‡ªé€‚åº”": {"æ¨èæŠ¤ç”²": "5çº§é˜²å¼¹è¡£ + å¤´ç›”", "é£é™©ç­‰çº§": "é«˜", "é¢„ä¼°æˆæœ¬": 150000},
}

# æ”¶ç›Šæ•°æ® (æŒ‰æ¨¡å¼)
REVENUE_DATA = {
    "æ™®é€š": {"å‡ºé‡‘ç‡": "25%", "å¹³å‡æ”¶ç›Š": 120000, "é£é™©": "ä½"},
    "æœºå¯†": {"å‡ºé‡‘ç‡": "45%", "å¹³å‡æ”¶ç›Š": 350000, "é£é™©": "ä¸­"},
    "ç»å¯†": {"å‡ºé‡‘ç‡": "70%", "å¹³å‡æ”¶ç›Š": 800000, "é£é™©": "æé«˜"},
    "è‡ªé€‚åº”": {"å‡ºé‡‘ç‡": "55%", "å¹³å‡æ”¶ç›Š": 500000, "é£é™©": "é«˜"},
}

# æŠ¤ç”²æˆæœ¬
ARMOR_COST = {3: 20000, 4: 50000, 5: 120000, 6: 250000}

# ==================== æ–°å¢: å¹²å‘˜æ•°æ® ====================

OPERATORS_DATA = {
    "çªå‡»å‹": {
        "éº¦å°é›¯": {
            "æŠ€èƒ½": "é—ªç”µçªå‡» - çŸ­æ—¶é—´å†…æå‡ç§»åŠ¨é€Ÿåº¦å’Œæ¢å¼¹é€Ÿåº¦",
            "è¢«åŠ¨": "æªæ¢°åååŠ›é™ä½10%",
            "é€‚åˆåœ°å›¾": ["ç›‘ç‹±", "èˆªå¤©"],
            "æ¨èæ­¦å™¨": ["å†²é”‹æª", "çªå‡»æ­¥æª"],
            "è¯„åˆ†": 9.2,
            "éš¾åº¦": "ä¸­ç­‰",
            "ç‰¹ç‚¹": "é«˜æœºåŠ¨æ€§ï¼Œé€‚åˆCQBçªç ´"
        },
        "å¨é¾™": {
            "æŠ€èƒ½": "æˆ˜æœ¯æ— äººæœº - ä¾¦å¯Ÿæ•Œäººä½ç½®",
            "è¢«åŠ¨": "ç„å‡†é€Ÿåº¦æå‡15%",
            "é€‚åˆåœ°å›¾": ["å¤§å", "é•¿å¼“", "å·´å…‹ä»€"],
            "æ¨èæ­¦å™¨": ["çªå‡»æ­¥æª", "ç‹™å‡»æ­¥æª"],
            "è¯„åˆ†": 8.8,
            "éš¾åº¦": "ç®€å•",
            "ç‰¹ç‚¹": "ä¿¡æ¯è·å–å¼ºï¼Œå›¢é˜Ÿæ ¸å¿ƒ"
        },
        "ç–¾é£": {
            "æŠ€èƒ½": "ç¿»æ»šé—ªé¿ - å¿«é€Ÿä½ç§»èº²é¿ä¼¤å®³",
            "è¢«åŠ¨": "å†²åˆºé€Ÿåº¦æå‡20%",
            "é€‚åˆåœ°å›¾": ["ç›‘ç‹±", "èˆªå¤©"],
            "æ¨èæ­¦å™¨": ["å†²é”‹æª", "éœ°å¼¹æª"],
            "è¯„åˆ†": 8.5,
            "éš¾åº¦": "å›°éš¾",
            "ç‰¹ç‚¹": "æé™æ“ä½œç©ºé—´å¤§"
        },
    },
    "å·¥ç¨‹å‹": {
        "æ¯”ç‰¹": {
            "æŠ€èƒ½": "æœºæ¢°èœ˜è›› - è‡ªçˆ†è…èš€æ•Œäººï¼Œå¢åŠ å—åˆ°ä¼¤å®³",
            "è¢«åŠ¨": "é™·é˜±æ”¾ç½®é€Ÿåº¦æå‡25%",
            "é€‚åˆåœ°å›¾": ["èˆªå¤©", "ç›‘ç‹±", "å¤§å"],
            "æ¨èæ­¦å™¨": ["å†²é”‹æª", "çªå‡»æ­¥æª"],
            "è¯„åˆ†": 8.7,
            "éš¾åº¦": "ä¸­ç­‰",
            "ç‰¹ç‚¹": "æ§åœºèƒ½åŠ›å¼ºï¼ŒS6æ–°å¹²å‘˜"
        },
        "è€å¤ª": {
            "æŠ€èƒ½": "åŠ å›ºæ¿ - å¼ºåŒ–é—¨çª—é˜²æŠ¤",
            "è¢«åŠ¨": "é˜²æŠ¤è£…å¤‡è€ä¹…+15%",
            "é€‚åˆåœ°å›¾": ["å¤§å", "é•¿å¼“"],
            "æ¨èæ­¦å™¨": ["çªå‡»æ­¥æª", "è½»æœºæª"],
            "è¯„åˆ†": 7.5,
            "éš¾åº¦": "ç®€å•",
            "ç‰¹ç‚¹": "é˜²å®ˆä¸“ç²¾ï¼Œé€‚åˆæ–°æ‰‹"
        },
    },
    "åŒ»ç–—å‹": {
        "èœ‚åŒ»": {
            "æŠ€èƒ½": "æ²»ç–—é’ˆå‰‚ - å¿«é€Ÿæ¢å¤é˜Ÿå‹ç”Ÿå‘½",
            "è¢«åŠ¨": "åŒ»ç–—ç‰©å“æ•ˆæœ+20%",
            "é€‚åˆåœ°å›¾": ["å·´å…‹ä»€", "èˆªå¤©", "ç›‘ç‹±"],
            "æ¨èæ­¦å™¨": ["å†²é”‹æª", "æ‰‹æª"],
            "è¯„åˆ†": 9.0,
            "éš¾åº¦": "ç®€å•",
            "ç‰¹ç‚¹": "å›¢é˜Ÿç»­èˆªæ ¸å¿ƒ"
        },
        "æ·±è“": {
            "æŠ€èƒ½": "è‚¾ä¸Šè…ºç´ æ³¨å°„ - æš‚æ—¶å…ç–«ä¼¤å®³",
            "è¢«åŠ¨": "è‡ªæˆ‘æ¢å¤é€Ÿåº¦+30%",
            "é€‚åˆåœ°å›¾": ["èˆªå¤©", "ç›‘ç‹±"],
            "æ¨èæ­¦å™¨": ["çªå‡»æ­¥æª", "å†²é”‹æª"],
            "è¯„åˆ†": 8.3,
            "éš¾åº¦": "ä¸­ç­‰",
            "ç‰¹ç‚¹": "ç”Ÿå­˜èƒ½åŠ›å¼º"
        },
    },
    "ä¾¦å¯Ÿå‹": {
        "æ— å": {
            "æŠ€èƒ½": "éšèº«æŠ«é£ - çŸ­æ—¶é—´éšå½¢",
            "è¢«åŠ¨": "è„šæ­¥å£°é™ä½50%",
            "é€‚åˆåœ°å›¾": ["ç›‘ç‹±", "èˆªå¤©", "å¤§å"],
            "æ¨èæ­¦å™¨": ["å†²é”‹æª", "è¿‘æˆ˜æ­¦å™¨"],
            "è¯„åˆ†": 8.9,
            "éš¾åº¦": "å›°éš¾",
            "ç‰¹ç‚¹": "å·è¢­ä¸“ç²¾ï¼Œé«˜é£é™©é«˜å›æŠ¥"
        },
        "å“ˆå¤«å…‹": {
            "æŠ€èƒ½": "è„‘æœºæ¥å£ - æ ‡è®°æ•Œäºº",
            "è¢«åŠ¨": "æ•Œäººæ ‡è®°æŒç»­æ—¶é—´+5ç§’",
            "é€‚åˆåœ°å›¾": ["å·´å…‹ä»€", "é•¿å¼“"],
            "æ¨èæ­¦å™¨": ["ç‹™å‡»æ­¥æª", "DMR"],
            "è¯„åˆ†": 8.6,
            "éš¾åº¦": "ä¸­ç­‰",
            "ç‰¹ç‚¹": "è¿œè·ç¦»ä¿¡æ¯æˆ˜"
        },
    },
}

# æ­¦å™¨å¸‚åœºä»·æ ¼æ•°æ® (æ¨¡æ‹Ÿäº¤æ˜“è¡Œä»·æ ¼)
WEAPONS_MARKET = {
    "çªå‡»æ­¥æª": {
        "M4A1": {"åŸºç¡€ä»·": 45000, "æ”¹è£…ä»·": 85000, "å¼¹è¯æ¶ˆè€—": 800},
        "AK-47": {"åŸºç¡€ä»·": 38000, "æ”¹è£…ä»·": 72000, "å¼¹è¯æ¶ˆè€—": 750},
        "HK416": {"åŸºç¡€ä»·": 52000, "æ”¹è£…ä»·": 98000, "å¼¹è¯æ¶ˆè€—": 850},
        "SCAR-L": {"åŸºç¡€ä»·": 48000, "æ”¹è£…ä»·": 88000, "å¼¹è¯æ¶ˆè€—": 820},
        "SCAR-H": {"åŸºç¡€ä»·": 55000, "æ”¹è£…ä»·": 102000, "å¼¹è¯æ¶ˆè€—": 900},
    },
    "å†²é”‹æª": {
        "MP5": {"åŸºç¡€ä»·": 25000, "æ”¹è£…ä»·": 48000, "å¼¹è¯æ¶ˆè€—": 600},
        "UMP45": {"åŸºç¡€ä»·": 22000, "æ”¹è£…ä»·": 42000, "å¼¹è¯æ¶ˆè€—": 550},
        "P90": {"åŸºç¡€ä»·": 35000, "æ”¹è£…ä»·": 65000, "å¼¹è¯æ¶ˆè€—": 650},
        "MP7": {"åŸºç¡€ä»·": 32000, "æ”¹è£…ä»·": 58000, "å¼¹è¯æ¶ˆè€—": 620},
        "Vector": {"åŸºç¡€ä»·": 40000, "æ”¹è£…ä»·": 75000, "å¼¹è¯æ¶ˆè€—": 700},
    },
    "ç‹™å‡»æ­¥æª": {
        "AWM": {"åŸºç¡€ä»·": 85000, "æ”¹è£…ä»·": 150000, "å¼¹è¯æ¶ˆè€—": 1500},
        "M24": {"åŸºç¡€ä»·": 65000, "æ”¹è£…ä»·": 110000, "å¼¹è¯æ¶ˆè€—": 1200},
        "Kar98k": {"åŸºç¡€ä»·": 58000, "æ”¹è£…ä»·": 95000, "å¼¹è¯æ¶ˆè€—": 1100},
        "SVD": {"åŸºç¡€ä»·": 72000, "æ”¹è£…ä»·": 125000, "å¼¹è¯æ¶ˆè€—": 1350},
    },
    "éœ°å¼¹æª": {
        "M870": {"åŸºç¡€ä»·": 18000, "æ”¹è£…ä»·": 35000, "å¼¹è¯æ¶ˆè€—": 400},
        "SPAS-12": {"åŸºç¡€ä»·": 22000, "æ”¹è£…ä»·": 42000, "å¼¹è¯æ¶ˆè€—": 450},
    },
    "æ‰‹æª": {
        "æ ¼æ´›å…‹18": {"åŸºç¡€ä»·": 8000, "æ”¹è£…ä»·": 15000, "å¼¹è¯æ¶ˆè€—": 300},
        "æ²™æ¼ ä¹‹é¹°": {"åŸºç¡€ä»·": 15000, "æ”¹è£…ä»·": 28000, "å¼¹è¯æ¶ˆè€—": 500},
        "M1911": {"åŸºç¡€ä»·": 6000, "æ”¹è£…ä»·": 12000, "å¼¹è¯æ¶ˆè€—": 280},
    },
}

# æŠ¤ç”²å¸‚åœºä»·æ ¼
ARMOR_MARKET = {
    "3çº§é˜²å¼¹è¡£": {"ä»·æ ¼": 20000, "è€ä¹…": 35, "é˜²æŠ¤": "30%"},
    "4çº§é˜²å¼¹è¡£": {"ä»·æ ¼": 50000, "è€ä¹…": 45, "é˜²æŠ¤": "45%"},
    "5çº§é˜²å¼¹è¡£": {"ä»·æ ¼": 120000, "è€ä¹…": 55, "é˜²æŠ¤": "60%"},
    "6çº§é˜²å¼¹è¡£": {"ä»·æ ¼": 250000, "è€ä¹…": 65, "é˜²æŠ¤": "75%"},
    "3çº§å¤´ç›”": {"ä»·æ ¼": 15000, "è€ä¹…": 25, "é˜²æŠ¤": "25%"},
    "4çº§å¤´ç›”": {"ä»·æ ¼": 35000, "è€ä¹…": 35, "é˜²æŠ¤": "40%"},
    "5çº§å¤´ç›”": {"ä»·æ ¼": 80000, "è€ä¹…": 45, "é˜²æŠ¤": "55%"},
    "6çº§å¤´ç›”": {"ä»·æ ¼": 180000, "è€ä¹…": 55, "é˜²æŠ¤": "70%"},
}

# åŒ»ç–—ç‰©èµ„ä»·æ ¼
MEDICAL_MARKET = {
    "æ­¢è¡€å¸¦": {"ä»·æ ¼": 2500, "æ•ˆæœ": "æ­¢è¡€", "æ•°é‡å»ºè®®": "3-4"},
    "ç»·å¸¦": {"ä»·æ ¼": 1500, "æ•ˆæœ": "å°é‡æ¢å¤", "æ•°é‡å»ºè®®": "5-8"},
    "åŒ»ç–—åŒ…": {"ä»·æ ¼": 8000, "æ•ˆæœ": "å¤§é‡æ¢å¤", "æ•°é‡å»ºè®®": "1-2"},
    "æ€¥æ•‘åŒ…": {"ä»·æ ¼": 15000, "æ•ˆæœ": "æ»¡è¡€", "æ•°é‡å»ºè®®": "0-1"},
    "æ­¢ç—›è¯": {"ä»·æ ¼": 3500, "æ•ˆæœ": "ä¸´æ—¶å¢ç›Š", "æ•°é‡å»ºè®®": "2-3"},
    "è‚¾ä¸Šè…ºç´ ": {"ä»·æ ¼": 12000, "æ•ˆæœ": "æé™ç»­å‘½", "æ•°é‡å»ºè®®": "0-1"},
}

# æŠ•æ·ç‰©ä»·æ ¼
THROWABLES_MARKET = {
    "çƒŸé›¾å¼¹": {"ä»·æ ¼": 3000, "ç”¨é€”": "æ©æŠ¤æ’¤ç¦»/è¿›æ”»"},
    "é—ªå…‰å¼¹": {"ä»·æ ¼": 4000, "ç”¨é€”": "æ¸…æˆ¿å¿…å¤‡"},
    "ç ´ç‰‡æ‰‹é›·": {"ä»·æ ¼": 8000, "ç”¨é€”": "AOEä¼¤å®³"},
    "ç‡ƒçƒ§å¼¹": {"ä»·æ ¼": 6000, "ç”¨é€”": "åŒºåŸŸå°é”"},
    "åœŸè±†é›·": {"ä»·æ ¼": 5000, "ç”¨é€”": "é™·é˜±åŸ‹ä¼"},
}

# èµ›å­£æ®µä½æ•°æ®
RANK_DATA = {
    "é’é“œ": {"åˆ†æ•°èŒƒå›´": "0-999", "å¥–åŠ±": "èµ›å­£çš®è‚¤ç¢ç‰‡x10"},
    "ç™½é“¶": {"åˆ†æ•°èŒƒå›´": "1000-1999", "å¥–åŠ±": "èµ›å­£çš®è‚¤ç¢ç‰‡x25"},
    "é»„é‡‘": {"åˆ†æ•°èŒƒå›´": "2000-2999", "å¥–åŠ±": "èµ›å­£çš®è‚¤ç¢ç‰‡x50"},
    "é“‚é‡‘": {"åˆ†æ•°èŒƒå›´": "3000-3999", "å¥–åŠ±": "èµ›å­£çš®è‚¤ç¢ç‰‡x80"},
    "é’»çŸ³": {"åˆ†æ•°èŒƒå›´": "4000-4999", "å¥–åŠ±": "èµ›å­£ä¸“å±çš®è‚¤"},
    "å¤§å¸ˆ": {"åˆ†æ•°èŒƒå›´": "5000-5999", "å¥–åŠ±": "èµ›å­£ä¸“å±çš®è‚¤+ç§°å·"},
    "ä¸‰è§’æ´²å·…å³°": {"åˆ†æ•°èŒƒå›´": "6000+", "å¥–åŠ±": "é™å®šçš®è‚¤+ä¸“å±å¤´åƒæ¡†"},
}

# ==================== å®æ—¶æ•°æ®è¯»å–åŠŸèƒ½ ====================

def load_live_session():
    """åŠ è½½å®æ—¶ä¼šè¯æ•°æ®"""
    data_dir = Path.home() / "Documents" / "DeltaTool"
    live_session_file = data_dir / "live_session.json"
    
    if live_session_file.exists():
        try:
            with open(live_session_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        except:
            return None
    return None

def load_all_game_records():
    """åŠ è½½æ‰€æœ‰æ¸¸æˆè®°å½•ï¼ˆåŒ…æ‹¬JSONå’ŒCSVï¼‰"""
    data_dir = Path.home() / "Documents" / "DeltaTool"
    records = []
    
    # æ–¹å¼1ï¼šå°è¯•è¯»å–JSONæ–‡ä»¶
    json_file = data_dir / "game_records.json"
    if json_file.exists():
        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                json_records = json.load(f)
                print(f"[DEBUG] ä»JSONåŠ è½½äº† {len(json_records)} æ¡è®°å½•")
                records.extend(json_records)
        except Exception as e:
            print(f"[DEBUG] è¯»å–JSONå¤±è´¥: {e}")
    
    # æ–¹å¼2ï¼šå°è¯•è¯»å–æ‰€æœ‰CSVæ–‡ä»¶
    csv_files = list(data_dir.glob("*.csv"))
    print(f"[DEBUG] æ‰¾åˆ° {len(csv_files)} ä¸ªCSVæ–‡ä»¶: {[f.name for f in csv_files]}")
    for csv_file in csv_files:
        try:
            df = pd.read_csv(csv_file, encoding='utf-8-sig')
            print(f"[DEBUG] ä» {csv_file.name} åŠ è½½äº† {len(df)} æ¡è®°å½•")
            if len(df) > 0:
                # è½¬æ¢CSVä¸ºè®°å½•æ ¼å¼
                for _, row in df.iterrows():
                    # å¤„ç†survivedå­—æ®µï¼ˆå¯èƒ½æ˜¯å¸ƒå°”å€¼æˆ–å­—ç¬¦ä¸²ï¼‰
                    survived_val = row.get('survived', True)
                    if isinstance(survived_val, str):
                        survived = survived_val.lower() in ['true', '1', 'yes', 'âœ…']
                    else:
                        survived = bool(survived_val)
                    
                    record = {
                        "datetime": row.get('datetime', ''),
                        "map": row.get('map', 'æœªçŸ¥'),
                        "mode": row.get('mode', 'æœªçŸ¥'),
                        "zone": row.get('zone', ''),
                        "items": row.get('items', ''),
                        "profit": int(row.get('profit', 0)) if pd.notna(row.get('profit')) else 0,
                        "survived": survived
                    }
                    # é¿å…é‡å¤ï¼ˆç®€å•æ£€æŸ¥datetimeï¼‰
                    if not any(r.get('datetime') == record['datetime'] for r in records):
                        records.append(record)
        except Exception as e:
            print(f"[DEBUG] è¯»å– {csv_file.name} å¤±è´¥: {e}")
    
    print(f"[DEBUG] æ€»å…±åŠ è½½ {len(records)} æ¡è®°å½•")
    
    if records:
        return pd.DataFrame(records)
    return None

# åˆå§‹åŒ–session_state
if 'game_records' not in st.session_state:
    st.session_state.game_records = []
    # å°è¯•ä»æ–‡ä»¶åŠ è½½å†å²æ•°æ®
    df = load_all_game_records()
    print(f"[DEBUG] load_all_game_records è¿”å›: {df is not None}, é•¿åº¦: {len(df) if df is not None else 0}")
    if df is not None and len(df) > 0:
        print(f"[DEBUG] DataFrame åˆ—: {list(df.columns)}")
        print(f"[DEBUG] DataFrame å†…å®¹:\n{df}")
        for idx, row in df.iterrows():
            record = {
                "æ—¥æœŸ": str(row.get('datetime', '')),
                "åœ°å›¾": str(row.get('map', 'æœªçŸ¥')),
                "æ¨¡å¼": str(row.get('mode', 'æœªçŸ¥')),
                "åˆ·æ–°ç‚¹": str(row.get('zone', '')),
                "ç‰©èµ„": str(row.get('items', '')),
                "ä»·å€¼": int(row.get('profit', 0)) if pd.notna(row.get('profit')) else 0,
                "æ’¤ç¦»": "âœ…" if row.get('survived', True) else "âŒ"
            }
            print(f"[DEBUG] æ·»åŠ è®°å½•: {record}")
            st.session_state.game_records.append(record)
        print(f"[DEBUG] æ€»å…±åŠ è½½ {len(st.session_state.game_records)} æ¡è®°å½•")
    else:
        print("[DEBUG] æ²¡æœ‰æ‰¾åˆ°å†å²æ•°æ®")

# ==================== ä¾§è¾¹æ å¯¼èˆª ====================

with st.sidebar:
    st.markdown("## ğŸ¯ ä¸‰è§’æ´²æˆ˜æœ¯ç»ˆç«¯ v4.0")
    st.markdown("---")
    
    # æ˜¾ç¤ºå®æ—¶ä¼šè¯ä¿¡æ¯
    live_session = load_live_session()
    if live_session and live_session.get("status") == "è¿›è¡Œä¸­":
        st.success("ğŸ® æ¸¸æˆè¿›è¡Œä¸­")
        col1, col2 = st.columns(2)
        with col1:
            st.metric("åœ°å›¾", live_session.get("map", "--"))
        with col2:
            st.metric("å½“å‰ä»·å€¼", f"Â¥{live_session.get('total_value', 0):,}")
        st.markdown("---")
    
    menu = st.radio(
        "åŠŸèƒ½èœå•",
        ["ğŸ  æˆ˜å¤‡é…ç½®", "ğŸ’° æˆ˜å¤‡è®¡ç®—å™¨", "ğŸ–ï¸ å¹²å‘˜æŒ‡å—", "ğŸ—ºï¸ æˆ˜æœ¯åœ°å›¾", 
         "ğŸ“Š ç‰©èµ„åˆ†æ", "ğŸ’ è£…å¤‡æ¨è", "ğŸ“ˆ æ•°æ®ç®¡ç†", "ğŸ“‹ æ¸¸æˆè®°å½•",
         "ğŸ“‰ æ·±åº¦åˆ†æ", "ğŸ¤– æ™ºèƒ½æ¨è", "ğŸ’» å®æ—¶ç›‘æ§"],
        index=0
    )
    
    st.markdown("---")
    st.markdown("### ğŸ“… ç³»ç»Ÿä¿¡æ¯")
    st.info(f"æ›´æ–°æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    st.caption("æ•°æ®æ¥æº: ç¤¾åŒºç»Ÿè®¡ + TapTap + ä¸ªäººè®°å½•")
    
    st.markdown("---")
    st.markdown("### ğŸ® å¿«æ·ç»Ÿè®¡")
    
    # ä»sessionä¸­è®¡ç®—ç»Ÿè®¡
    if 'game_records' in st.session_state and st.session_state.game_records:
        total_games = len(st.session_state.game_records)
        total_profit = sum(r.get('ä»·å€¼', 0) for r in st.session_state.game_records if r.get('æ’¤ç¦»') == "âœ…")
        st.metric("æ€»å±€æ•°", total_games)
        st.metric("ç´¯è®¡æ”¶ç›Š", f"{int(total_profit):,}")
    else:
        st.metric("æ€»å±€æ•°", 0)
        st.metric("ç´¯è®¡æ”¶ç›Š", "Â¥0")

# ==================== åŠŸèƒ½æ¨¡å— ====================

# è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—å‡ºè´§æ¦‚ç‡
def get_loot_probability(map_name, mode):
    base_probs = BASE_LOOT_PROBABILITY[map_name]
    modifier = MODE_INFO[mode]["loot_modifier"]
    return {item: min(prob * modifier, 95) for item, prob in base_probs.items()}

if menu == "ğŸ  æˆ˜å¤‡é…ç½®":
    st.title("ğŸš€ æˆ˜å¤‡é…ç½®ä¸æ”¶ç›Šé¢„æµ‹")
    st.caption("å½“å‰çŠ¶æ€ï¼šç³»ç»Ÿåœ¨çº¿ | å®æ—¶è®¡ç®— | S6èµ›å­£é˜¿è¨æ‹‰")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("ğŸ› ï¸ é…ç½®å‚æ•°")
        # åœ°å›¾å’Œæ¨¡å¼åˆ†å¼€é€‰æ‹©
        selected_map = st.selectbox("é€‰æ‹©åœ°å›¾", MAP_LIST)
        available_modes = MAP_MODES[selected_map]
        selected_mode = st.selectbox("é€‰æ‹©æ¨¡å¼", available_modes)
        
        armor_level = st.slider("æŠ¤ç”²ç­‰çº§ (3-6çº§)", 3, 6, 5)
        ammo_price = st.number_input("å•å‘å­å¼¹ä»·æ ¼ (å“ˆå¤«å¸)", value=850, step=50)
        ammo_count = st.number_input("æºå¸¦å¼¹è¯æ•°é‡", value=180, step=30)
        
        # é¢å¤–æˆæœ¬
        extra_cost = st.number_input("å…¶ä»–æˆæœ¬ (åŒ»ç–—/æŠ•æ·ç‰©ç­‰)", value=15000, step=1000)
    
    with col2:
        st.subheader("ğŸ“Š æ”¶ç›Šé¢„æµ‹")
        
        # è®¡ç®—é€»è¾‘
        total_cost = ARMOR_COST[armor_level] + (ammo_price * ammo_count) + extra_cost
        revenue_info = REVENUE_DATA[selected_mode]
        expected_revenue = revenue_info["å¹³å‡æ”¶ç›Š"]
        expected_profit = expected_revenue - total_cost
        
        # æ˜¾ç¤ºç»“æœ
        col_a, col_b = st.columns(2)
        with col_a:
            st.metric("é¢„è®¡å‡ºé‡‘ç‡", revenue_info["å‡ºé‡‘ç‡"])
            st.metric("å¹³å‡æ”¶ç›Š", f"{expected_revenue:,} å“ˆå¤«å¸")
        with col_b:
            st.metric("æ€»æˆæœ¬", f"{total_cost:,} å“ˆå¤«å¸")
            delta_color = "normal" if expected_profit > 0 else "inverse"
            st.metric("é¢„ä¼°å‡€åˆ©æ¶¦", f"{expected_profit:,}", 
                     delta="ç›ˆåˆ©" if expected_profit > 0 else "äºæŸ",
                     delta_color=delta_color)
        
        # é£é™©æç¤º
        st.markdown("---")
        risk = revenue_info["é£é™©"]
        mode_info = MODE_INFO[selected_mode]
        if risk == "æé«˜":
            st.error(f"âš ï¸ é£é™©ç­‰çº§: {risk} - å»ºè®®æºå¸¦æœ€é«˜çº§è£…å¤‡ï¼Œç»„é˜Ÿè¡ŒåŠ¨ï¼")
        elif risk == "é«˜":
            st.warning(f"âš¡ é£é™©ç­‰çº§: {risk} - éš¾åº¦åŠ¨æ€å˜åŒ–ï¼Œæ³¨æ„é€‚åº”")
        elif risk == "ä¸­":
            st.warning(f"âš¡ é£é™©ç­‰çº§: {risk} - æ³¨æ„æˆ˜æœ¯é…åˆï¼Œè§„åˆ’æ’¤ç¦»è·¯çº¿")
        else:
            st.success(f"âœ… é£é™©ç­‰çº§: {risk} - é€‚åˆç»ƒä¹ å’Œç§¯ç´¯èµ„æº")
    
    # åœ°å›¾ä¿¡æ¯
    st.markdown("---")
    st.subheader(f"ğŸ—ºï¸ {selected_map} ({selected_mode}) - åœ°å›¾ä¿¡æ¯")
    map_info = MAPS_DATA[selected_map]
    mode_detail = MODE_INFO[selected_mode]
    
    col1, col2, col3 = st.columns(3)
    with col1:
        st.markdown(f"**æè¿°:** {map_info['description']}")
        st.markdown(f"**åœ°å›¾å¤§å°:** {map_info['size']}")
    with col2:
        st.markdown(f"**éš¾åº¦:** {mode_detail['difficulty']}")
        st.markdown(f"**ç©å®¶æ•°:** {mode_detail['player_count']}")
    with col3:
        hot_zones_names = [z['name'] if isinstance(z, dict) else str(z) for z in map_info['hot_zones']]
        extract_names = [e['name'] if isinstance(e, dict) else str(e) for e in map_info['extract_points']]
        st.markdown(f"**çƒ­ç‚¹åŒºåŸŸ:** {', '.join(hot_zones_names)}")
        st.markdown(f"**æ’¤ç¦»ç‚¹:** {', '.join(extract_names)}")

elif menu == "ğŸ’° æˆ˜å¤‡è®¡ç®—å™¨":
    st.title("ğŸ’° æˆ˜å¤‡ä»·å€¼è®¡ç®—å™¨")
    st.caption("ğŸ”¥ å®æ—¶è®¡ç®—æœ€ä½ä»·æˆ˜å¤‡é…ç½® - é¼ é¼ ç©å®¶å¿…å¤‡å·¥å…·ï¼")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ”« æ­¦å™¨è®¡ç®—", "ğŸ›¡ï¸ é˜²æŠ¤è®¡ç®—", "ğŸ“¦ å®Œæ•´é…ç½®"])
    
    with tab1:
        st.subheader("æ­¦å™¨å¸‚åœºä»·æ ¼æŸ¥è¯¢")
        
        weapon_type = st.selectbox("æ­¦å™¨ç±»å‹", list(WEAPONS_MARKET.keys()))
        
        # æ˜¾ç¤ºè¯¥ç±»å‹æ‰€æœ‰æ­¦å™¨
        weapons = WEAPONS_MARKET[weapon_type]
        
        df_weapons = pd.DataFrame([
            {
                "æ­¦å™¨åç§°": name,
                "åŸºç¡€ä»·æ ¼": f"{info['åŸºç¡€ä»·']:,}",
                "æ”¹è£…ä»·æ ¼": f"{info['æ”¹è£…ä»·']:,}",
                "æ¯å‘å¼¹è¯": f"{info['å¼¹è¯æ¶ˆè€—']:,}",
                "30å‘å¼¹åŒ£": f"{info['å¼¹è¯æ¶ˆè€—'] * 30:,}"
            }
            for name, info in weapons.items()
        ])
        st.dataframe(df_weapons, use_container_width=True, hide_index=True)
        
        # è®¡ç®—å™¨
        st.markdown("---")
        st.subheader("ğŸ’µ æˆæœ¬è®¡ç®—å™¨")
        
        col1, col2 = st.columns(2)
        with col1:
            selected_weapon = st.selectbox("é€‰æ‹©æ­¦å™¨", list(weapons.keys()))
            use_modded = st.checkbox("ä½¿ç”¨æ”¹è£…ç‰ˆæœ¬", value=False)
            ammo_mags = st.slider("æºå¸¦å¼¹åŒ£æ•°", 1, 10, 3)
        
        with col2:
            weapon_info = weapons[selected_weapon]
            weapon_cost = weapon_info['æ”¹è£…ä»·'] if use_modded else weapon_info['åŸºç¡€ä»·']
            ammo_cost = weapon_info['å¼¹è¯æ¶ˆè€—'] * 30 * ammo_mags
            total = weapon_cost + ammo_cost
            
            st.metric("æ­¦å™¨æˆæœ¬", f"{weapon_cost:,} å“ˆå¤«å¸")
            st.metric("å¼¹è¯æˆæœ¬", f"{ammo_cost:,} å“ˆå¤«å¸")
            st.metric("æ€»è®¡", f"{total:,} å“ˆå¤«å¸", delta=f"{ammo_mags*30}å‘å¼¹è¯")
    
    with tab2:
        st.subheader("é˜²æŠ¤è£…å¤‡ä»·æ ¼")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("### ğŸ¦º é˜²å¼¹è¡£")
            for name, info in ARMOR_MARKET.items():
                if "é˜²å¼¹è¡£" in name:
                    st.markdown(f"**{name}** - ğŸ’°{info['ä»·æ ¼']:,} | è€ä¹…:{info['è€ä¹…']} | é˜²æŠ¤:{info['é˜²æŠ¤']}")
        
        with col2:
            st.markdown("### ğŸª– å¤´ç›”")
            for name, info in ARMOR_MARKET.items():
                if "å¤´ç›”" in name:
                    st.markdown(f"**{name}** - ğŸ’°{info['ä»·æ ¼']:,} | è€ä¹…:{info['è€ä¹…']} | é˜²æŠ¤:{info['é˜²æŠ¤']}")
        
        st.markdown("---")
        st.subheader("è®¡ç®—é˜²æŠ¤è£…å¤‡æˆæœ¬")
        
        col1, col2, col3 = st.columns(3)
        with col1:
            armor_choice = st.selectbox("é€‰æ‹©é˜²å¼¹è¡£", [k for k in ARMOR_MARKET.keys() if "é˜²å¼¹è¡£" in k])
        with col2:
            helmet_choice = st.selectbox("é€‰æ‹©å¤´ç›”", ["ä¸å¸¦å¤´ç›”"] + [k for k in ARMOR_MARKET.keys() if "å¤´ç›”" in k])
        with col3:
            armor_cost = ARMOR_MARKET[armor_choice]["ä»·æ ¼"]
            helmet_cost = ARMOR_MARKET[helmet_choice]["ä»·æ ¼"] if helmet_choice != "ä¸å¸¦å¤´ç›”" else 0
            st.metric("é˜²æŠ¤æ€»æˆæœ¬", f"{armor_cost + helmet_cost:,}")
    
    with tab3:
        st.subheader("ğŸ“¦ å®Œæ•´æˆ˜å¤‡é…ç½®è®¡ç®—")
        st.markdown("ä¸€é”®è®¡ç®—ä½ çš„å®Œæ•´å‡ºè£…æˆæœ¬ï¼")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.markdown("### ğŸ”« æ­¦å™¨é…ç½®")
            main_weapon_type = st.selectbox("ä¸»æ­¦å™¨ç±»å‹", list(WEAPONS_MARKET.keys()), key="main_type")
            main_weapon = st.selectbox("ä¸»æ­¦å™¨", list(WEAPONS_MARKET[main_weapon_type].keys()), key="main")
            main_modded = st.checkbox("ä¸»æ­¦å™¨æ”¹è£…", key="main_mod")
            main_ammo = st.slider("ä¸»æ­¦å™¨å¼¹åŒ£", 1, 8, 4, key="main_ammo")
            
            secondary_type = st.selectbox("å‰¯æ­¦å™¨ç±»å‹", list(WEAPONS_MARKET.keys()), key="sec_type")
            secondary_weapon = st.selectbox("å‰¯æ­¦å™¨", list(WEAPONS_MARKET[secondary_type].keys()), key="sec")
            secondary_ammo = st.slider("å‰¯æ­¦å™¨å¼¹åŒ£", 0, 4, 2, key="sec_ammo")
        
        with col2:
            st.markdown("### ğŸ›¡ï¸ é˜²æŠ¤è£…å¤‡")
            full_armor = st.selectbox("é˜²å¼¹è¡£", list(ARMOR_MARKET.keys())[:4], key="full_armor")
            full_helmet = st.selectbox("å¤´ç›”", ["ä¸å¸¦"] + list(ARMOR_MARKET.keys())[4:], key="full_helmet")
            
            st.markdown("### ğŸ’Š åŒ»ç–—ç‰©èµ„")
            med_items = {}
            for item, info in MEDICAL_MARKET.items():
                med_items[item] = st.number_input(
                    f"{item} (å»ºè®®:{info['æ•°é‡å»ºè®®']})", 
                    0, 10, 
                    int(info['æ•°é‡å»ºè®®'].split('-')[0]),
                    key=f"med_{item}"
                )
        
        with col3:
            st.markdown("### ğŸ’£ æŠ•æ·ç‰©")
            throw_items = {}
            for item, info in THROWABLES_MARKET.items():
                throw_items[item] = st.number_input(f"{item}", 0, 5, 0, key=f"throw_{item}")
        
        # è®¡ç®—æ€»æˆæœ¬
        st.markdown("---")
        st.subheader("ğŸ’° æ€»æˆæœ¬ç»Ÿè®¡")
        
        main_info = WEAPONS_MARKET[main_weapon_type][main_weapon]
        sec_info = WEAPONS_MARKET[secondary_type][secondary_weapon]
        
        costs = {
            "ä¸»æ­¦å™¨": main_info['æ”¹è£…ä»·'] if main_modded else main_info['åŸºç¡€ä»·'],
            "ä¸»æ­¦å™¨å¼¹è¯": main_info['å¼¹è¯æ¶ˆè€—'] * 30 * main_ammo,
            "å‰¯æ­¦å™¨": sec_info['åŸºç¡€ä»·'],
            "å‰¯æ­¦å™¨å¼¹è¯": sec_info['å¼¹è¯æ¶ˆè€—'] * 30 * secondary_ammo,
            "é˜²å¼¹è¡£": ARMOR_MARKET[full_armor]["ä»·æ ¼"],
            "å¤´ç›”": ARMOR_MARKET[full_helmet]["ä»·æ ¼"] if full_helmet != "ä¸å¸¦" else 0,
            "åŒ»ç–—ç‰©èµ„": sum(MEDICAL_MARKET[item]["ä»·æ ¼"] * count for item, count in med_items.items()),
            "æŠ•æ·ç‰©": sum(THROWABLES_MARKET[item]["ä»·æ ¼"] * count for item, count in throw_items.items()),
        }
        
        total_cost = sum(costs.values())
        
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("æ­¦å™¨+å¼¹è¯", f"{costs['ä¸»æ­¦å™¨']+costs['ä¸»æ­¦å™¨å¼¹è¯']+costs['å‰¯æ­¦å™¨']+costs['å‰¯æ­¦å™¨å¼¹è¯']:,}")
        with col2:
            st.metric("é˜²æŠ¤è£…å¤‡", f"{costs['é˜²å¼¹è¡£']+costs['å¤´ç›”']:,}")
        with col3:
            st.metric("æ¶ˆè€—å“", f"{costs['åŒ»ç–—ç‰©èµ„']+costs['æŠ•æ·ç‰©']:,}")
        with col4:
            st.metric("ğŸ’° æ€»è®¡", f"{total_cost:,}", delta="å“ˆå¤«å¸")
        
        # æˆæœ¬åˆ†æå›¾
        fig = px.pie(
            values=list(costs.values()),
            names=list(costs.keys()),
            title="æˆæœ¬æ„æˆåˆ†æ"
        )
        fig.update_layout(paper_bgcolor='rgba(0,0,0,0)', font_color='white')
        st.plotly_chart(fig, use_container_width=True)
        
        # çœé’±å»ºè®®
        if total_cost > 200000:
            st.error("âš ï¸ æˆ˜å¤‡æˆæœ¬è¾ƒé«˜ï¼å»ºè®®ï¼šé™ä½æŠ¤ç”²ç­‰çº§æˆ–ä½¿ç”¨åŸºç¡€æ­¦å™¨æ¥å‡å°‘é£é™©")
        elif total_cost > 100000:
            st.warning("ğŸ’¡ ä¸­ç­‰æˆæœ¬é…ç½®ï¼Œå»ºè®®é€‰æ‹©ä¸­é«˜çº§åœ°å›¾ä»¥è·å¾—æ›´å¥½æ”¶ç›Š")
        else:
            st.success("âœ… ç»æµå‹é…ç½®ï¼é€‚åˆè·‘åˆ€ç§¯ç´¯èµ„é‡‘")

elif menu == "ğŸ–ï¸ å¹²å‘˜æŒ‡å—":
    st.title("ğŸ–ï¸ å¹²å‘˜é€‰æ‹©æŒ‡å—")
    st.caption("æ ¹æ®åœ°å›¾å’Œç©æ³•é€‰æ‹©æœ€ä½³å¹²å‘˜ - æ•°æ®æ¥æº: TapTapç¤¾åŒº")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ“‹ å¹²å‘˜æ€»è§ˆ", "ğŸ—ºï¸ åœ°å›¾æ¨è", "âš”ï¸ é˜µå®¹æ­é…"])
    
    with tab1:
        st.subheader("å…¨å¹²å‘˜æ•°æ®åº“")
        
        for op_type, operators in OPERATORS_DATA.items():
            st.markdown(f"### {op_type}")
            
            cols = st.columns(len(operators))
            for idx, (name, info) in enumerate(operators.items()):
                with cols[idx]:
                    st.markdown(f"""
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                                padding: 1rem; border-radius: 10px; border: 1px solid #444;">
                        <h4 style="color: #FFD700;">ğŸ‘¤ {name}</h4>
                        <p><b>è¯„åˆ†:</b> â­ {info['è¯„åˆ†']}/10</p>
                        <p><b>éš¾åº¦:</b> {info['éš¾åº¦']}</p>
                        <p><b>æŠ€èƒ½:</b> {info['æŠ€èƒ½']}</p>
                        <p><b>è¢«åŠ¨:</b> {info['è¢«åŠ¨']}</p>
                        <p><b>ç‰¹ç‚¹:</b> {info['ç‰¹ç‚¹']}</p>
                    </div>
                    """, unsafe_allow_html=True)
            st.markdown("---")
    
    with tab2:
        st.subheader("æ ¹æ®åœ°å›¾é€‰æ‹©å¹²å‘˜")
        
        target_map = st.selectbox("é€‰æ‹©ç›®æ ‡åœ°å›¾", list(MAPS_DATA.keys()))
        
        st.markdown(f"### ğŸ—ºï¸ {target_map} æ¨èå¹²å‘˜")
        
        recommended = []
        for op_type, operators in OPERATORS_DATA.items():
            for name, info in operators.items():
                if target_map in info['é€‚åˆåœ°å›¾']:
                    recommended.append({
                        "ç±»å‹": op_type,
                        "å¹²å‘˜": name,
                        "è¯„åˆ†": info['è¯„åˆ†'],
                        "ç‰¹ç‚¹": info['ç‰¹ç‚¹'],
                        "æ¨èæ­¦å™¨": ", ".join(info['æ¨èæ­¦å™¨'])
                    })
        
        if recommended:
            df_rec = pd.DataFrame(recommended).sort_values("è¯„åˆ†", ascending=False)
            st.dataframe(df_rec, use_container_width=True, hide_index=True)
            
            # æ˜¾ç¤ºæœ€ä½³é€‰æ‹©
            best = df_rec.iloc[0]
            st.success(f"ğŸ† æœ€ä½³é€‰æ‹©: **{best['å¹²å‘˜']}** ({best['ç±»å‹']}) - {best['ç‰¹ç‚¹']}")
        else:
            st.info("è¯¥åœ°å›¾æš‚æ— ç‰¹åˆ«æ¨èçš„å¹²å‘˜")
    
    with tab3:
        st.subheader("ä¸‰äººå°é˜Ÿé˜µå®¹æ­é…")
        st.markdown("æ¨èçš„å›¢é˜Ÿé…ç½®ç»„åˆ")
        
        team_presets = [
            {
                "åç§°": "ğŸ”¥ çªå‡»å°é˜Ÿ",
                "é˜µå®¹": ["éº¦å°é›¯(çªå‡»)", "ç–¾é£(çªå‡»)", "èœ‚åŒ»(åŒ»ç–—)"],
                "æˆ˜æœ¯": "å¿«é€Ÿçªç ´ï¼Œå‹åˆ¶æ•Œäººï¼Œé€‚åˆçŸ¿å±±ã€ç ”ç©¶æ‰€ç­‰CQBåœ°å›¾",
                "éš¾åº¦": "å›°éš¾"
            },
            {
                "åç§°": "ğŸ›¡ï¸ é˜²å®ˆåå‡»",
                "é˜µå®¹": ["è€å¤ª(å·¥ç¨‹)", "æ·±è“(åŒ»ç–—)", "å¨é¾™(çªå‡»)"],
                "æˆ˜æœ¯": "ç¨³æ‰ç¨³æ‰“ï¼Œåˆ©ç”¨åŠ å›ºæ¿å®ˆç‚¹ï¼Œç­‰æ•Œäººæ¥é€",
                "éš¾åº¦": "ç®€å•"
            },
            {
                "åç§°": "ğŸ‘ï¸ æƒ…æŠ¥ä¼˜å…ˆ",
                "é˜µå®¹": ["å¨é¾™(çªå‡»)", "å“ˆå¤«å…‹(ä¾¦å¯Ÿ)", "èœ‚åŒ»(åŒ»ç–—)"],
                "æˆ˜æœ¯": "æ— äººæœº+æ ‡è®°æŒæ§ä¿¡æ¯ï¼Œè¿œè·ç¦»äº¤æˆ˜",
                "éš¾åº¦": "ä¸­ç­‰"
            },
            {
                "åç§°": "ğŸ•µï¸ æ¸—é€å°é˜Ÿ",
                "é˜µå®¹": ["æ— å(ä¾¦å¯Ÿ)", "æ¯”ç‰¹(å·¥ç¨‹)", "ç–¾é£(çªå‡»)"],
                "æˆ˜æœ¯": "éšèº«+é™·é˜±+å¿«é€Ÿè½¬ç§»ï¼Œå·è¢­ä¸“ç²¾",
                "éš¾åº¦": "å›°éš¾"
            },
        ]
        
        for preset in team_presets:
            with st.expander(f"{preset['åç§°']} - éš¾åº¦: {preset['éš¾åº¦']}"):
                st.markdown(f"**é˜µå®¹:** {' + '.join(preset['é˜µå®¹'])}")
                st.markdown(f"**æˆ˜æœ¯:** {preset['æˆ˜æœ¯']}")

elif menu == "ğŸ“Š ç‰©èµ„åˆ†æ":
    st.title("ğŸ“Š ç‰©èµ„å‡ºè´§åˆ†æä¸æ¦‚ç‡æ¨¡æ‹Ÿ")
    st.caption("åˆ†æç‰©èµ„å‡ºè´§æ¦‚ç‡ | æ¨¡æ‹Ÿè·‘åˆ€æ”¶ç›Š | å¤šåœ°å›¾å¯¹æ¯”")
    
    # ä¸»åŠŸèƒ½æ ‡ç­¾é¡µ
    tab1, tab2, tab3, tab4 = st.tabs(["ğŸ“ˆ å‡ºè´§æ¦‚ç‡åˆ†æ", "ğŸ² å•æ¬¡æ¨¡æ‹Ÿ", "ğŸ“Š æ‰¹é‡ç»Ÿè®¡", "ğŸ—ºï¸ åœ°å›¾å¯¹æ¯”"])
    
    # ========== å‡ºè´§æ¦‚ç‡åˆ†æ ==========
    with tab1:
        st.subheader("ğŸ“ˆ åœ°å›¾ç‰©èµ„å‡ºè´§æ¦‚ç‡")
        
        col1, col2 = st.columns([1, 2])
        
        with col1:
            selected_map = st.selectbox("é€‰æ‹©åœ°å›¾", MAP_LIST, key="loot_map")
            available_modes = MAP_MODES[selected_map]
            selected_mode = st.selectbox("é€‰æ‹©æ¨¡å¼", available_modes, key="loot_mode")
            
            # åœ°å›¾ä¿¡æ¯å¡ç‰‡
            map_info = MAPS_DATA[selected_map]
            mode_info = MODE_INFO[selected_mode]
            st.markdown(f"""
            ### ğŸ—ºï¸ {selected_map} ({selected_mode})
            - **æè¿°:** {map_info['description']}
            - **å¤§å°:** {map_info['size']}
            - **éš¾åº¦:** {mode_info['difficulty']}
            - **ç©å®¶æ•°:** {map_info['player_count']}
            """)
            
            st.markdown("---")
            st.markdown("### ğŸ“ ç‰©èµ„åˆ·æ–°ç‚¹")
            hot_zones_data = map_info['hot_zones']
            for zone_data in hot_zones_data:
                if isinstance(zone_data, dict):
                    zone_name = zone_data['name']
                    zone_value = zone_data.get('value', 'æœªçŸ¥')
                    st.markdown(f"- ğŸ”¥ **{zone_name}** (ä»·å€¼: {zone_value})")
                else:
                    st.markdown(f"- {zone_data}")
        
        with col2:
            # å‡ºè´§æ¦‚ç‡å›¾è¡¨
            loot_data = get_loot_probability(selected_map, selected_mode)
            df = pd.DataFrame({
                "ç‰©èµ„ç±»å‹": list(loot_data.keys()),
                "å‡ºè´§æ¦‚ç‡(%)": [round(v, 1) for v in loot_data.values()]
            })
            
            # æŸ±çŠ¶å›¾
            fig = px.bar(
                df, 
                x="ç‰©èµ„ç±»å‹", 
                y="å‡ºè´§æ¦‚ç‡(%)",
                color="å‡ºè´§æ¦‚ç‡(%)",
                color_continuous_scale="YlOrRd",
                title=f"{selected_map} ({selected_mode}) - ç‰©èµ„å‡ºè´§æ¦‚ç‡"
            )
            fig.update_layout(
                plot_bgcolor='rgba(0,0,0,0)',
                paper_bgcolor='rgba(0,0,0,0)',
                font_color='white',
                height=400
            )
            st.plotly_chart(fig, use_container_width=True)
            
            # é›·è¾¾å›¾
            fig_radar = go.Figure()
            fig_radar.add_trace(go.Scatterpolar(
                r=[round(v, 1) for v in loot_data.values()],
                theta=list(loot_data.keys()),
                fill='toself',
                name=f"{selected_map}",
                line_color='#FFD700'
            ))
            fig_radar.update_layout(
                polar=dict(
                    radialaxis=dict(visible=True, range=[0, 100]),
                    bgcolor='rgba(0,0,0,0)'
                ),
                showlegend=False,
                paper_bgcolor='rgba(0,0,0,0)',
                font_color='white',
                title="ç‰©èµ„åˆ†å¸ƒé›·è¾¾å›¾",
                height=400
            )
            st.plotly_chart(fig_radar, use_container_width=True)
    
    # ========== å•æ¬¡æ¨¡æ‹Ÿ ==========
    with tab2:
        st.subheader("ğŸ² å•æ¬¡è·‘åˆ€æ¨¡æ‹Ÿ")
        st.markdown("æ¨¡æ‹Ÿä¸€æ¬¡æ¸¸æˆçš„ç‰©èµ„æœåˆ®æƒ…å†µ")
        
        col_sim1, col_sim2 = st.columns(2)
        with col_sim1:
            sim_map = st.selectbox("é€‰æ‹©åœ°å›¾", MAP_LIST, key="sim_map")
        with col_sim2:
            sim_modes = MAP_MODES[sim_map]
            sim_mode = st.selectbox("é€‰æ‹©æ¨¡å¼", sim_modes, key="sim_mode")
        
        map_info_sim = MAPS_DATA[sim_map]
        loot_zones_list = map_info_sim['loot_zones']
        
        col1, col2 = st.columns(2)
        with col1:
            sim_zone = st.selectbox("é€‰æ‹©æœç´¢åŒºåŸŸ", loot_zones_list)
        with col2:
            # åˆ¤æ–­æ˜¯å¦ä¸ºçƒ­ç‚¹
            hot_zones_list = [z['name'] if isinstance(z, dict) else z for z in map_info_sim['hot_zones']]
            is_hot_zone = sim_zone in hot_zones_list
            if is_hot_zone:
                st.warning("ğŸ”¥ çƒ­ç‚¹åŒºåŸŸï¼å‡ºè´§ç‡+50%")
            else:
                st.info("ğŸ“ æ™®é€šåŒºåŸŸ")
        
        if st.button("ğŸ² å¼€å§‹æœç´¢ï¼", type="primary", use_container_width=True):
            loot_probs = get_loot_probability(sim_map, sim_mode)
            modifier = 1.5 if is_hot_zone else 1.0
            
            results = []
            st.markdown("---")
            st.markdown("### ğŸ“¦ æœç´¢ç»“æœ:")
            
            for item, base_prob in loot_probs.items():
                actual_prob = min(base_prob * modifier, 100)
                roll = random.random() * 100
                found = roll < actual_prob
                
                if found:
                    if "é«˜çº§" in item:
                        value = random.randint(50000, 150000)
                        emoji = "ğŸ”´"
                    elif "ä¸­çº§" in item:
                        value = random.randint(15000, 50000)
                        emoji = "ğŸŸ£"
                    elif "é’¥åŒ™å¡" in item:
                        value = random.randint(80000, 200000)
                        emoji = "ğŸ”‘"
                    elif "æƒ…æŠ¥æ–‡ä»¶" in item:
                        value = random.randint(100000, 300000)
                        emoji = "ğŸ“„"
                    else:
                        value = random.randint(2000, 15000)
                        emoji = "âšª"
                    
                    results.append({"ç‰©èµ„": f"{emoji} {item}", "ä»·å€¼": value})
            
            if results:
                total_value = sum(r['ä»·å€¼'] for r in results)
                
                for r in results:
                    st.markdown(f"- {r['ç‰©èµ„']}: **{r['ä»·å€¼']:,}** å“ˆå¤«å¸")
                
                st.markdown("---")
                col_result1, col_result2 = st.columns(2)
                with col_result1:
                    st.metric("ğŸ’° æœ¬æ¬¡æ”¶ç›Š", f"{total_value:,} å“ˆå¤«å¸")
                with col_result2:
                    st.metric("ğŸ“¦ è·å¾—ç‰©å“", f"{len(results)} ä»¶")
                
                if total_value > 100000:
                    st.balloons()
                    st.success("ğŸ‰ å¤§ä¸°æ”¶ï¼è¿æ°”çˆ†æ£šï¼")
                elif total_value > 30000:
                    st.info("ğŸ‘ ä¸é”™çš„æ”¶è·")
                else:
                    st.warning("ğŸ˜… æ”¶è·ä¸€èˆ¬")
            else:
                st.error("ğŸ˜­ è¿™è¶Ÿè·‘ç©ºäº†...")
    
    # ========== æ‰¹é‡ç»Ÿè®¡ ==========
    with tab3:
        st.subheader("ğŸ“Š æ‰¹é‡æ¨¡æ‹Ÿç»Ÿè®¡")
        st.markdown("æ¨¡æ‹Ÿå¤šæ¬¡è·‘åˆ€ï¼Œç»Ÿè®¡å¹³å‡æ”¶ç›Šå’Œæ¦‚ç‡åˆ†å¸ƒ")
        
        col_batch1, col_batch2, col_batch3 = st.columns(3)
        with col_batch1:
            sim_map2 = st.selectbox("é€‰æ‹©åœ°å›¾", MAP_LIST, key="sim_map2")
        with col_batch2:
            sim_modes2 = MAP_MODES[sim_map2]
            sim_mode2 = st.selectbox("é€‰æ‹©æ¨¡å¼", sim_modes2, key="sim_mode2")
        with col_batch3:
            sim_runs = st.number_input("æ¨¡æ‹Ÿæ¬¡æ•°", 10, 1000, 100, 10)
        
        survival_rate = st.slider("é¢„ä¼°å­˜æ´»ç‡ (%)", 10, 100, 60)
        
        if st.button("ğŸš€ å¼€å§‹æ‰¹é‡æ¨¡æ‹Ÿ", type="primary", use_container_width=True):
            with st.spinner("æ¨¡æ‹Ÿä¸­..."):
                loot_probs = get_loot_probability(sim_map2, sim_mode2)
                
                all_runs = []
                for run in range(sim_runs):
                    survived = random.random() * 100 < survival_rate
                    
                    if survived:
                        run_value = 0
                        for item, prob in loot_probs.items():
                            if random.random() * 100 < prob:
                                if "é«˜çº§" in item:
                                    run_value += random.randint(50000, 150000)
                                elif "ä¸­çº§" in item:
                                    run_value += random.randint(15000, 50000)
                                elif "é’¥åŒ™å¡" in item:
                                    run_value += random.randint(80000, 200000)
                                elif "æƒ…æŠ¥æ–‡ä»¶" in item:
                                    run_value += random.randint(100000, 300000)
                                else:
                                    run_value += random.randint(2000, 15000)
                        all_runs.append({"å±€æ•°": run+1, "æ”¶ç›Š": run_value, "çŠ¶æ€": "å­˜æ´»"})
                    else:
                        all_runs.append({"å±€æ•°": run+1, "æ”¶ç›Š": 0, "çŠ¶æ€": "é˜µäº¡"})
                
                df_runs = pd.DataFrame(all_runs)
                
                # ç»Ÿè®¡å¡ç‰‡
                col1, col2, col3, col4 = st.columns(4)
                with col1:
                    st.metric("æ€»å±€æ•°", sim_runs)
                with col2:
                    actual_survival = len(df_runs[df_runs["çŠ¶æ€"] == "å­˜æ´»"]) / sim_runs * 100
                    st.metric("å®é™…å­˜æ´»ç‡", f"{actual_survival:.1f}%")
                with col3:
                    avg_profit = df_runs["æ”¶ç›Š"].mean()
                    st.metric("åœºå‡æ”¶ç›Š", f"{avg_profit:,.0f}")
                with col4:
                    total_profit = df_runs["æ”¶ç›Š"].sum()
                    st.metric("æ€»æ”¶ç›Š", f"{total_profit:,}")
                
                # å›¾è¡¨å±•ç¤º
                col_chart1, col_chart2 = st.columns(2)
                
                with col_chart1:
                    # æ”¶ç›Šåˆ†å¸ƒå›¾
                    fig = px.histogram(
                        df_runs[df_runs["æ”¶ç›Š"] > 0],
                        x="æ”¶ç›Š",
                        nbins=30,
                        title="æ”¶ç›Šåˆ†å¸ƒç›´æ–¹å›¾"
                    )
                    fig.update_layout(paper_bgcolor='rgba(0,0,0,0)', font_color='white')
                    st.plotly_chart(fig, use_container_width=True)
                
                with col_chart2:
                    # è¶‹åŠ¿å›¾
                    fig2 = px.line(
                        df_runs,
                        x="å±€æ•°",
                        y="æ”¶ç›Š",
                        title="æ”¶ç›Šè¶‹åŠ¿å›¾",
                        markers=True
                    )
                    fig2.update_layout(paper_bgcolor='rgba(0,0,0,0)', font_color='white')
                    st.plotly_chart(fig2, use_container_width=True)
                
                # è¯¦ç»†æ•°æ®è¡¨
                with st.expander("ğŸ“‹ æŸ¥çœ‹è¯¦ç»†æ•°æ®", expanded=False):
                    st.dataframe(df_runs, use_container_width=True)
    
    # ========== åœ°å›¾å¯¹æ¯” ==========
    with tab4:
        st.subheader("ğŸ—ºï¸ å¤šåœ°å›¾ç‰©èµ„å‡ºè´§å¯¹æ¯”")
        st.markdown("å¯¹æ¯”ä¸åŒåœ°å›¾çš„ç‰©èµ„å‡ºè´§æ¦‚ç‡")
        
        compare_mode = st.selectbox("å¯¹æ¯”æ¨¡å¼", ["æ™®é€š", "æœºå¯†", "ç»å¯†"], key="compare_mode")
        
        compare_items = st.multiselect(
            "é€‰æ‹©è¦å¯¹æ¯”çš„ç‰©èµ„ç±»å‹",
            list(BASE_LOOT_PROBABILITY["å¤§å"].keys()),
            default=["é«˜çº§æ­¦å™¨", "é«˜çº§æŠ¤ç”²", "é’¥åŒ™å¡"]
        )
        
        if compare_items:
            compare_data = []
            for map_name in MAP_LIST:
                if compare_mode in MAP_MODES[map_name]:
                    loot = get_loot_probability(map_name, compare_mode)
                    for item in compare_items:
                        compare_data.append({
                            "åœ°å›¾": map_name,
                            "ç‰©èµ„": item,
                            "æ¦‚ç‡(%)": round(loot[item], 1)
                        })
            
            if compare_data:
                df_compare = pd.DataFrame(compare_data)
                
                # åˆ†ç»„æŸ±çŠ¶å›¾
                fig_compare = px.bar(
                    df_compare,
                    x="åœ°å›¾",
                    y="æ¦‚ç‡(%)",
                    color="ç‰©èµ„",
                    barmode="group",
                    title=f"å„åœ°å›¾ç‰©èµ„å‡ºè´§æ¦‚ç‡å¯¹æ¯” ({compare_mode}æ¨¡å¼)"
                )
                fig_compare.update_layout(
                    plot_bgcolor='rgba(0,0,0,0)',
                    paper_bgcolor='rgba(0,0,0,0)',
                    font_color='white'
                )
                st.plotly_chart(fig_compare, use_container_width=True)
                
                # çƒ­åŠ›å›¾
                pivot_table = df_compare.pivot(index="ç‰©èµ„", columns="åœ°å›¾", values="æ¦‚ç‡(%)")
                fig_heatmap = px.imshow(
                    pivot_table,
                    labels=dict(x="åœ°å›¾", y="ç‰©èµ„", color="æ¦‚ç‡(%)"),
                    title="ç‰©èµ„å‡ºè´§æ¦‚ç‡çƒ­åŠ›å›¾",
                    color_continuous_scale="YlOrRd"
                )
                fig_heatmap.update_layout(paper_bgcolor='rgba(0,0,0,0)', font_color='white')
                st.plotly_chart(fig_heatmap, use_container_width=True)
        else:
            st.info("ğŸ‘† è¯·é€‰æ‹©è¦å¯¹æ¯”çš„ç‰©èµ„ç±»å‹")

elif menu == "ğŸ—ºï¸ æˆ˜æœ¯åœ°å›¾":
    st.title("ğŸ—ºï¸ æˆ˜æœ¯åœ°å›¾ä¸è·¯çº¿è§„åˆ’ç³»ç»Ÿ")
    st.caption("é›†æˆå¼åœ°å›¾å·¥å…· - å‡ºç”Ÿç‚¹åˆ†æ | æˆ˜æœ¯è·¯çº¿ | æ’¤ç¦»è§„åˆ’ | é«˜ä»·å€¼ç‚¹ä½")
    
    # åœ°å›¾é€‰æ‹©
    selected_map = st.selectbox("ğŸ¯ é€‰æ‹©åœ°å›¾", MAP_LIST, key="map_tool_select")
    map_info = MAPS_DATA[selected_map]
    
    # é¡¶éƒ¨ä¿¡æ¯å¡ç‰‡
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("åœ°å›¾è§„æ¨¡", map_info['size'])
    with col2:
        st.metric("ç©å®¶æ•°é‡", map_info['player_count'])
    with col3:
        st.metric("éš¾åº¦ç­‰çº§", map_info['difficulty'])
    with col4:
        st.metric("å‡ºç”Ÿç‚¹æ•°", len([p for points in (map_info['spawn_points'].values() if isinstance(map_info['spawn_points'], dict) else [map_info['spawn_points']]) for p in points]))
    
    st.markdown("---")
    
    # ä¸»å†…å®¹åŒº - ä½¿ç”¨æ ‡ç­¾é¡µç»„ç»‡
    tab1, tab2, tab3, tab4, tab5 = st.tabs(["ğŸ¯ å‡ºç”Ÿç‚¹åˆ†æ", "ğŸ”¥ é«˜ä»·å€¼åŒºåŸŸ", "ğŸš æ’¤ç¦»ç‚¹è§„åˆ’", "ğŸ—ºï¸ æˆ˜æœ¯è·¯çº¿", "ğŸ’¡ å®æˆ˜æŠ€å·§"])
    
    # ========== å‡ºç”Ÿç‚¹åˆ†æ ==========
    with tab1:
        st.subheader("ğŸ¯ å‡ºç”Ÿç‚¹æˆ˜æœ¯åˆ†æ")
        
        spawn_points = map_info['spawn_points']
        if isinstance(spawn_points, dict):
            for category, points in spawn_points.items():
                st.markdown(f"### {category}")
                
                for point in points:
                    with st.expander(f"ğŸ“ {point['name']}", expanded=False):
                        col_a, col_b = st.columns(2)
                        with col_a:
                            st.markdown(f"**æè¿°ï¼š** {point['desc']}")
                            st.markdown(f"**æ¨èæˆ˜æœ¯ï¼š** {point['strategy']}")
                        with col_b:
                            risk_color = {"ä½": "ğŸŸ¢", "è¾ƒä½": "ğŸŸ¡", "ä¸­ç­‰": "ğŸŸ ", "è¾ƒé«˜": "ğŸ”´", "é«˜": "ğŸ”´", "æé«˜": "ğŸ”´"}
                            st.markdown(f"**é£é™©ç­‰çº§ï¼š** {risk_color.get(point['risk'], 'âšª')} {point['risk']}")
                        
                        # æ·»åŠ å¯è§†åŒ–é£é™©æ¡
                        risk_value = {"ä½": 20, "è¾ƒä½": 40, "ä¸­ç­‰": 60, "è¾ƒé«˜": 80, "é«˜": 90, "æé«˜": 100}
                        st.progress(risk_value.get(point['risk'], 50) / 100)
        else:
            for point in spawn_points:
                with st.expander(f"ğŸ“ {point['name']}", expanded=False):
                    col_a, col_b = st.columns(2)
                    with col_a:
                        st.markdown(f"**æè¿°ï¼š** {point['desc']}")
                        st.markdown(f"**æ¨èæˆ˜æœ¯ï¼š** {point['strategy']}")
                    with col_b:
                        risk_color = {"ä½": "ğŸŸ¢", "è¾ƒä½": "ğŸŸ¡", "ä¸­ç­‰": "ğŸŸ ", "è¾ƒé«˜": "ğŸ”´", "é«˜": "ğŸ”´", "æé«˜": "ğŸ”´"}
                        st.markdown(f"**é£é™©ç­‰çº§ï¼š** {risk_color.get(point['risk'], 'âšª')} {point['risk']}")
                    
                    # æ·»åŠ å¯è§†åŒ–é£é™©æ¡
                    risk_value = {"ä½": 20, "è¾ƒä½": 40, "ä¸­ç­‰": 60, "è¾ƒé«˜": 80, "é«˜": 90, "æé«˜": 100}
                    st.progress(risk_value.get(point['risk'], 50) / 100)
        
        st.info("ğŸ’¡ **å‡ºç”Ÿç‚¹é€‰æ‹©å»ºè®®ï¼š** æ–°æ‰‹ä¼˜å…ˆé€‰æ‹©ä½é£é™©å‡ºç”Ÿç‚¹ç¨³å¥å‘è‚²ï¼Œè€æ‰‹å¯ä»¥é€‰æ‹©é«˜é£é™©é«˜å›æŠ¥çš„ä¸­å¿ƒåŒºåŸŸ")
    
    # ========== é«˜ä»·å€¼åŒºåŸŸ ==========
    with tab2:
        st.subheader("ğŸ”¥ é«˜ä»·å€¼ç‰©èµ„åŒºåŸŸ")
        
        for zone in map_info['hot_zones']:
            with st.container():
                st.markdown(f"### ğŸ¯ {zone['name']}")
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    value_color = {"ä½": "ğŸŸ¢", "ä¸­ç­‰": "ğŸŸ¡", "é«˜": "ğŸŸ ", "æé«˜": "ğŸ”´"}
                    st.metric("ä»·å€¼ç­‰çº§", f"{value_color.get(zone['value'], 'âšª')} {zone['value']}")
                with col2:
                    danger_color = {"ä½": "ğŸŸ¢", "ä¸­ç­‰": "ğŸŸ¡", "é«˜": "ğŸŸ ", "æé«˜": "ğŸ”´"}
                    st.metric("å±é™©ç¨‹åº¦", f"{danger_color.get(zone['danger'], 'âšª')} {zone['danger']}")
                with col3:
                    st.metric("ç‰©èµ„ç§ç±»", len(zone['items']))
                
                st.markdown("**å¯è·å¾—ç‰©èµ„ï¼š**")
                items_text = " | ".join([f"ğŸ {item}" for item in zone['items']])
                st.markdown(items_text)
                
                # ä»·å€¼-å±é™©æ¯”åˆ†æ
                value_score = {"ä½": 1, "ä¸­ç­‰": 2, "é«˜": 3, "æé«˜": 4}
                danger_score = {"ä½": 1, "ä¸­ç­‰": 2, "é«˜": 3, "æé«˜": 4}
                ratio = value_score.get(zone['value'], 2) / danger_score.get(zone['danger'], 2)
                
                if ratio > 1:
                    st.success(f"âœ… æ€§ä»·æ¯”ï¼šé«˜ï¼ˆ{ratio:.2f}ï¼‰ - æ¨èå‰å¾€")
                elif ratio > 0.7:
                    st.warning(f"âš ï¸ æ€§ä»·æ¯”ï¼šä¸­ç­‰ï¼ˆ{ratio:.2f}ï¼‰ - è°¨æ…å‰å¾€")
                else:
                    st.error(f"âŒ æ€§ä»·æ¯”ï¼šä½ï¼ˆ{ratio:.2f}ï¼‰ - ä¸å»ºè®®å‰å¾€")
                
                st.markdown("---")
        
        st.info("ğŸ’¡ **æœåˆ®å»ºè®®ï¼š** ä¼˜å…ˆæœç´¢æ€§ä»·æ¯”é«˜çš„åŒºåŸŸï¼Œå›¢é˜Ÿä½œæˆ˜æ—¶å¯ä»¥æŒ‘æˆ˜é«˜å±é«˜ä»·å€¼åŒºåŸŸ")
    
    # ========== æ’¤ç¦»ç‚¹è§„åˆ’ ==========
    with tab3:
        st.subheader("ğŸš æ’¤ç¦»ç‚¹é€‰æ‹©ä¸è§„åˆ’")
        
        for idx, extract in enumerate(map_info['extract_points'], 1):
            with st.container():
                col1, col2 = st.columns([3, 1])
                
                with col1:
                    st.markdown(f"### {idx}. {extract['name']}")
                    st.markdown(f"**ä½ç½®ï¼š** {extract['location']}")
                
                with col2:
                    risk_emoji = {"ä½": "ğŸŸ¢", "è¾ƒä½": "ğŸŸ¡", "ä¸­ç­‰": "ğŸŸ ", "è¾ƒé«˜": "ğŸ”´", "é«˜": "ğŸ”´", "æé«˜": "ğŸ”´"}
                    st.markdown(f"### {risk_emoji.get(extract['risk'], 'âšª')}")
                
                col_a, col_b, col_c = st.columns(3)
                with col_a:
                    st.metric("è·ç¦»", extract['distance'])
                with col_b:
                    st.metric("é£é™©", extract['risk'])
                with col_c:
                    # è®¡ç®—æ¨èåº¦
                    distance_score = {"è¿‘": 3, "ä¸­": 2, "è¿œ": 1}
                    risk_score = {"ä½": 3, "è¾ƒä½": 2.5, "ä¸­ç­‰": 2, "è¾ƒé«˜": 1.5, "é«˜": 1, "æé«˜": 0.5}
                    recommend = distance_score.get(extract['distance'], 2) + risk_score.get(extract['risk'], 1.5)
                    st.metric("æ¨èåº¦", f"{recommend:.1f}/6.0")
                
                st.markdown("---")
        
        st.info("ğŸ’¡ **æ’¤ç¦»å»ºè®®ï¼š** æ’¤ç¦»å‰è§‚å¯Ÿå‘¨å›´3åˆ†é’Ÿï¼Œç¡®ä¿å®‰å…¨å†è¡ŒåŠ¨ã€‚å¦‚æœè¢«è¿½æ€ï¼Œé€‰æ‹©è¿œä½†å®‰å…¨çš„æ’¤ç¦»ç‚¹")
    
    # ========== æˆ˜æœ¯è·¯çº¿ ==========
    with tab4:
        st.subheader("ğŸ—ºï¸ æ¨èæˆ˜æœ¯è·¯çº¿")
        
        for idx, route in enumerate(map_info['tactical_routes'], 1):
            with st.expander(f"ğŸ“ è·¯çº¿{idx}ï¼š{route['name']}", expanded=True):
                col1, col2 = st.columns([2, 1])
                
                with col1:
                    st.markdown(f"**è·¯çº¿è§„åˆ’ï¼š**")
                    # å°†è·¯çº¿æ‹†åˆ†æˆæ­¥éª¤
                    steps = route['path'].split('â†’')
                    for step_idx, step in enumerate(steps, 1):
                        if step_idx < len(steps):
                            st.markdown(f"{step_idx}. {step.strip()} âœ")
                        else:
                            st.markdown(f"{step_idx}. {step.strip()} ğŸ")
                
                with col2:
                    st.metric("é¢„è®¡æ—¶é—´", route['time'])
                    
                    profit_emoji = {"ä½": "ğŸ’°", "ä¸­ç­‰": "ğŸ’°ğŸ’°", "ä¸­é«˜": "ğŸ’°ğŸ’°ğŸ’°", "é«˜": "ğŸ’°ğŸ’°ğŸ’°ğŸ’°", "æé«˜": "ğŸ’°ğŸ’°ğŸ’°ğŸ’°ğŸ’°"}
                    st.metric("é¢„æœŸæ”¶ç›Š", f"{profit_emoji.get(route['profit'], 'ğŸ’°')} {route['profit']}")
                
                # è·¯çº¿å¯è§†åŒ–ï¼ˆä½¿ç”¨è¿›åº¦æ¡æ¨¡æ‹Ÿï¼‰
                st.markdown("**è·¯çº¿è¿›åº¦æ¨¡æ‹Ÿï¼š**")
                st.progress(100)
        
        st.info("ğŸ’¡ **è·¯çº¿é€‰æ‹©ï¼š** æ ¹æ®ä½ çš„è£…å¤‡å’ŒæŠ€æœ¯é€‰æ‹©åˆé€‚è·¯çº¿ã€‚æ–°æ‰‹æ¨èç¨³å¥è·¯çº¿ï¼Œé«˜æ‰‹å¯ä»¥å°è¯•é€Ÿæ”»")
    
    # ========== å®æˆ˜æŠ€å·§ ==========
    with tab5:
        st.subheader("ğŸ’¡ å®æˆ˜æŠ€å·§ä¸æ³¨æ„äº‹é¡¹")
        
        st.markdown(f"### ğŸ“‹ {selected_map} åœ°å›¾ç‰¹è‰²")
        st.markdown(f"> {map_info['description']}")
        
        st.markdown("---")
        st.markdown("### ğŸ¯ æ ¸å¿ƒæŠ€å·§")
        
        for tip in map_info['tips']:
            st.markdown(tip)
        
        st.markdown("---")
        
        # é€šç”¨æŠ€å·§
        st.markdown("### ğŸŒŸ é€šç”¨æˆ˜æœ¯å»ºè®®")
        
        col1, col2 = st.columns(2)
        with col1:
            st.markdown("""
            **å‰æœŸï¼ˆ0-5åˆ†é’Ÿï¼‰ï¼š**
            - ğŸƒ å¿«é€Ÿç¦»å¼€å‡ºç”Ÿç‚¹
            - ğŸ” æœåˆ®æœ€è¿‘çš„å»ºç­‘
            - ğŸ‘‚ æ³¨æ„å‘¨å›´å£°éŸ³
            - ğŸ’Š ä¼˜å…ˆæ‰¾æŠ¤ç”²å’ŒåŒ»ç–—åŒ…
            """)
            
            st.markdown("""
            **ä¸­æœŸï¼ˆ5-12åˆ†é’Ÿï¼‰ï¼š**
            - ğŸ¯ å‰å¾€é«˜ä»·å€¼åŒºåŸŸ
            - ğŸ¤ ç»„é˜Ÿè¡ŒåŠ¨æ›´å®‰å…¨
            - ğŸ“¦ é€‰æ‹©æ€§æœåˆ®
            - âš¡ ä¿æŒç§»åŠ¨é¿å…è¢«è¹²
            """)
        
        with col2:
            st.markdown("""
            **åæœŸï¼ˆ12-15åˆ†é’Ÿï¼‰ï¼š**
            - ğŸš è§„åˆ’æ’¤ç¦»è·¯çº¿
            - ğŸ’ æ•´ç†èƒŒåŒ…ç©ºé—´
            - ğŸ‘€ è§‚å¯Ÿæ’¤ç¦»ç‚¹
            - ğŸƒ æœæ–­æ’¤ç¦»
            """)
            
            st.markdown("""
            **æˆ˜æ–—æŠ€å·§ï¼š**
            - ğŸ§ å£°éŸ³å®šä½æ•Œäºº
            - ğŸ›¡ï¸ åˆ©ç”¨æ©ä½“
            - ğŸ”« çˆ†å¤´ä¼˜å…ˆ
            - ğŸ’£ å–„ç”¨æŠ•æ·ç‰©
            """)
        
        st.success("ğŸ–ï¸ **è®°ä½ï¼š** å­˜æ´»æ‰èƒ½å¸¦å‡ºæˆ˜åˆ©å“ï¼ä¸è¦è´ªå¿ƒï¼Œè§å¥½å°±æ”¶")
    
    # åº•éƒ¨æ“ä½œæŒ‰é’®
    st.markdown("---")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("ğŸ“Š æŸ¥çœ‹è¯¥åœ°å›¾å†å²æ•°æ®", use_container_width=True):
            st.info(f"æ­£åœ¨åŠ è½½ {selected_map} çš„å†å²æ•°æ®...")
    
    with col2:
        if st.button("ğŸ® å¼€å§‹æ–°æ¸¸æˆä¼šè¯", type="primary", use_container_width=True):
            st.success("æ¸¸æˆä¼šè¯å·²å¼€å§‹ï¼å‰å¾€'å®æ—¶ä¼šè¯'é¡µé¢è®°å½•")
    
    with col3:
        if st.button("ğŸ”— æ‰“å¼€å®˜æ–¹åœ°å›¾", use_container_width=True):
            st.markdown('[ğŸŒ ç‚¹å‡»æ‰“å¼€å®˜æ–¹åœ°å›¾å·¥å…·](https://df.qq.com/cp/a20240729directory/)', unsafe_allow_html=True)

elif menu == "ğŸ’ è£…å¤‡æ¨è":
    st.title("ğŸ’ æœ€ä½³æˆ˜å¤‡æ¨è")
    
    # åœ°å›¾å’Œæ¨¡å¼é€‰æ‹©
    col_select1, col_select2 = st.columns(2)
    with col_select1:
        selected_map = st.selectbox("é€‰æ‹©ç›®æ ‡åœ°å›¾", MAP_LIST, key="loadout_map")
    with col_select2:
        available_modes = MAP_MODES[selected_map]
        selected_mode = st.selectbox("é€‰æ‹©æ¨¡å¼", available_modes, key="loadout_mode")
    
    loadout = LOADOUT_RECOMMENDATIONS[selected_map]
    mode_loadout = MODE_LOADOUT[selected_mode]
    
    # é£é™©ç­‰çº§æ˜¾ç¤º
    risk = mode_loadout["é£é™©ç­‰çº§"]
    if risk == "æé«˜":
        st.error(f"âš ï¸ é£é™©ç­‰çº§: {risk}")
    elif risk == "é«˜":
        st.warning(f"âš¡ é£é™©ç­‰çº§: {risk}")
    elif risk == "ä¸­":
        st.info(f"ğŸ“Š é£é™©ç­‰çº§: {risk}")
    else:
        st.success(f"âœ… é£é™©ç­‰çº§: {risk}")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("### ğŸ”« ä¸»æ­¦å™¨æ¨è")
        for weapon in loadout["ä¸»æ­¦å™¨"]:
            st.markdown(f"- {weapon}")
        
        st.markdown("### ğŸ”« å‰¯æ­¦å™¨æ¨è")
        for weapon in loadout["å‰¯æ­¦å™¨"]:
            st.markdown(f"- {weapon}")
    
    with col2:
        st.markdown("### ğŸ›¡ï¸ é˜²æŠ¤è£…å¤‡")
        st.info(mode_loadout["æ¨èæŠ¤ç”²"])
        
        st.markdown("### ğŸ”§ æ¨èé…ä»¶")
        for attachment in loadout["æ¨èé…ä»¶"]:
            st.markdown(f"- {attachment}")
    
    with col3:
        st.markdown("### ğŸ’Š å¿…å¸¦ç‰©èµ„")
        for item in loadout["å¿…å¸¦ç‰©èµ„"]:
            st.markdown(f"- {item}")
        
        st.markdown("### ğŸ’° é¢„ä¼°æˆæœ¬")
        st.metric("æ€»æˆæœ¬", f"{mode_loadout['é¢„ä¼°æˆæœ¬']:,} å“ˆå¤«å¸")
    
    # æˆ˜æœ¯å»ºè®®
    st.markdown("---")
    st.markdown("### ğŸ’¡ æˆ˜æœ¯å»ºè®®")
    st.success(loadout["æˆ˜æœ¯å»ºè®®"])
    
    # åœ°å›¾æ‰€æœ‰è£…å¤‡å¯¹æ¯”
    st.markdown("---")
    st.subheader("ğŸ“Š å„åœ°å›¾+æ¨¡å¼æ¨èè£…å¤‡å¯¹æ¯”")
    
    comparison_data = []
    for map_name in MAP_LIST:
        for mode in MAP_MODES[map_name]:
            rec = LOADOUT_RECOMMENDATIONS[map_name]
            mode_rec = MODE_LOADOUT[mode]
            comparison_data.append({
                "åœ°å›¾": map_name,
                "æ¨¡å¼": mode,
                "ä¸»æ­¦å™¨": rec["ä¸»æ­¦å™¨"][0],
                "æŠ¤ç”²": mode_rec["æ¨èæŠ¤ç”²"],
                "é£é™©": mode_rec["é£é™©ç­‰çº§"],
                "é¢„ä¼°æˆæœ¬": f"{mode_rec['é¢„ä¼°æˆæœ¬']:,}"
            })
    
    df_comparison = pd.DataFrame(comparison_data)
    st.dataframe(df_comparison, use_container_width=True, hide_index=True)

elif menu == "ğŸ“ˆ æ•°æ®ç®¡ç†":
    st.title("ğŸ“ˆ æ•°æ®ç®¡ç†")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ“ æ–‡ä»¶ä¸Šä¼ ", "âœï¸ æ‰‹åŠ¨å½•å…¥", "ğŸ“Š æˆ‘çš„æ•°æ®"])
    
    with tab1:
        st.markdown("### ä¸Šä¼ å‡ºè´§è®°å½•")
        st.markdown("æ”¯æŒ CSV æ ¼å¼ï¼ŒåŒ…å«åˆ—: datetime, map, mode, zone, items, profit, survived")
        
        uploaded_file = st.file_uploader("é€‰æ‹© CSV æ–‡ä»¶", type=['csv'])
        if uploaded_file:
            try:
                df = pd.read_csv(uploaded_file, encoding='utf-8-sig')
                st.dataframe(df, use_container_width=True)
                
                # è½¬æ¢æ•°æ®æ ¼å¼åˆ° game_records
                if 'game_records' not in st.session_state:
                    st.session_state.game_records = []
                
                # å°†ä¸Šä¼ çš„æ•°æ®è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
                for _, row in df.iterrows():
                    record = {
                        "æ—¥æœŸ": row.get('datetime', datetime.now().strftime("%Y-%m-%d %H:%M")),
                        "åœ°å›¾": row.get('map', 'æœªçŸ¥'),
                        "æ¨¡å¼": row.get('mode', 'æœªçŸ¥'),
                        "åˆ·æ–°ç‚¹": row.get('zone', ''),
                        "ç‰©èµ„": row.get('items', ''),
                        "ä»·å€¼": int(row.get('profit', 0)) if pd.notna(row.get('profit')) else 0,
                        "æ’¤ç¦»": "âœ…" if row.get('survived', True) else "âŒ"
                    }
                    st.session_state.game_records.append(record)
                
                # æ›´æ–°ç»Ÿè®¡
                if 'total_games' not in st.session_state:
                    st.session_state.total_games = 0
                    st.session_state.total_profit = 0
                
                st.session_state.total_games = len(st.session_state.game_records)
                st.session_state.total_profit = sum(
                    r['ä»·å€¼'] for r in st.session_state.game_records 
                    if r['æ’¤ç¦»'] == "âœ…"
                )
                
                st.success(f"âœ… æˆåŠŸå¯¼å…¥ {len(df)} æ¡è®°å½•ï¼")
                st.balloons()
                
                # åŒæ—¶ä¿å­˜åˆ°æ–‡æ¡£ç›®å½•
                try:
                    save_dir = Path.home() / "Documents" / "DeltaTool"
                    save_dir.mkdir(parents=True, exist_ok=True)
                    import time
                    ts = time.strftime("%Y%m%d_%H%M%S")
                    save_path = save_dir / f"uploaded_game_records_{ts}.csv"
                    df.to_csv(save_path, index=False, encoding='utf-8-sig')
                    st.info(f"ğŸ“ å·²å¤‡ä»½åˆ°: {save_path}")
                except Exception as e:
                    st.warning(f"å¤‡ä»½å¤±è´¥: {e}")
                    
            except Exception as e:
                st.error(f"âŒ å¯¼å…¥å¤±è´¥: {e}")
                st.info("è¯·ç¡®ä¿CSVæ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼ŒåŒ…å«ä»¥ä¸‹åˆ—ï¼šdatetime, map, mode, zone, items, profit, survived")
    
    with tab2:
        st.markdown("### æ‰‹åŠ¨å½•å…¥å‡ºè´§è®°å½•")
        
        col1, col2 = st.columns(2)
        with col1:
            record_map = st.selectbox("åœ°å›¾", MAP_LIST, key="record_map")
            record_modes = MAP_MODES[record_map]
            record_mode = st.selectbox("æ¨¡å¼", record_modes, key="record_mode")
            
            # å¤„ç†å‡ºç”Ÿç‚¹æ˜¾ç¤ºï¼ˆæ”¯æŒåˆ†ç»„å’Œåˆ—è¡¨ä¸¤ç§æ ¼å¼ï¼‰
            spawn_points = MAPS_DATA[record_map]["spawn_points"]
            if isinstance(spawn_points, dict):
                # åˆ†ç»„æ˜¾ç¤ºï¼ˆæ–°æ ¼å¼ï¼šå­—å…¸åŒ…å«è¯¦ç»†ä¿¡æ¯ï¼‰
                all_spawns = []
                for category, points in spawn_points.items():
                    # æ£€æŸ¥pointsæ˜¯åˆ—è¡¨è¿˜æ˜¯å­—å…¸åˆ—è¡¨
                    if points and isinstance(points[0], dict):
                        all_spawns.extend([f"{category}: {p['name']}" for p in points])
                    else:
                        all_spawns.extend([f"{category}: {p}" for p in points])
                record_zone = st.selectbox("å‡ºç”Ÿç‚¹", all_spawns)
            else:
                # ç®€å•åˆ—è¡¨æ˜¾ç¤ºï¼ˆæ£€æŸ¥æ˜¯å¦ä¸ºå­—å…¸æ ¼å¼ï¼‰
                if spawn_points and isinstance(spawn_points[0], dict):
                    spawn_names = [p['name'] for p in spawn_points]
                    record_zone = st.selectbox("å‡ºç”Ÿç‚¹", spawn_names)
                else:
                    record_zone = st.selectbox("å‡ºç”Ÿç‚¹", spawn_points)
        
        with col2:
            record_item = st.text_input("è·å¾—ç‰©èµ„")
            record_value = st.number_input("ç‰©èµ„ä»·å€¼ (å“ˆå¤«å¸)", value=0, step=1000)
            record_survived = st.checkbox("æˆåŠŸæ’¤ç¦»", value=True)
        
        if st.button("æ·»åŠ è®°å½•", type="primary"):
            if 'game_records' not in st.session_state:
                st.session_state.game_records = []
            
            st.session_state.game_records.append({
                "æ—¥æœŸ": datetime.now().strftime("%Y-%m-%d %H:%M"),
                "åœ°å›¾": record_map,
                "æ¨¡å¼": record_mode,
                "åˆ·æ–°ç‚¹": record_zone,
                "ç‰©èµ„": record_item,
                "ä»·å€¼": record_value,
                "æ’¤ç¦»": "âœ…" if record_survived else "âŒ"
            })
            
            st.session_state.total_games += 1
            if record_survived:
                st.session_state.total_profit += record_value
            
            st.success(f"âœ… å·²è®°å½•: åœ¨ {record_map} çš„ {record_zone} è·å¾— {record_item}")
            st.balloons()
    
    with tab3:
        st.markdown("### æˆ‘çš„æ¸¸æˆè®°å½•")
        
        if 'game_records' in st.session_state and st.session_state.game_records:
            df_records = pd.DataFrame(st.session_state.game_records)
            st.dataframe(df_records, use_container_width=True, hide_index=True)
            
            # ç»Ÿè®¡
            st.markdown("---")
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("æ€»å±€æ•°", len(df_records))
            with col2:
                survived = len(df_records[df_records["æ’¤ç¦»"] == "âœ…"])
                st.metric("å­˜æ´»ç‡", f"{survived/len(df_records)*100:.1f}%")
            with col3:
                total_value = df_records["ä»·å€¼"].sum()
                st.metric("æ€»æ”¶ç›Š", f"{total_value:,}")
            
            # ä¸‹è½½
            csv = df_records.to_csv(index=False).encode('utf-8')
            st.download_button("ğŸ“¥ å¯¼å‡ºæ•°æ®", csv, "game_records.csv", "text/csv")
        else:
            st.info("æš‚æ— è®°å½•ï¼Œè¯·å…ˆæ‰‹åŠ¨å½•å…¥æˆ–ä¸Šä¼ æ•°æ®")

elif menu == "ğŸ“‹ æ¸¸æˆè®°å½•":
    st.title("ğŸ“‹ æ¸¸æˆè®°å½•ä¸ç»Ÿè®¡")
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
    if 'game_records' in st.session_state and st.session_state.game_records:
        df_list = []
        for record in st.session_state.game_records:
            df_list.append({
                "æ—¥æœŸ": record.get("æ—¥æœŸ", ""),
                "åœ°å›¾": record.get("åœ°å›¾", ""),
                "æ¨¡å¼": record.get("æ¨¡å¼", ""),
                "åˆ·æ–°ç‚¹": record.get("åˆ·æ–°ç‚¹", ""),
                "ç‰©èµ„": record.get("ç‰©èµ„", ""),
                "ä»·å€¼": record.get("ä»·å€¼", 0),
                "æ’¤ç¦»": record.get("æ’¤ç¦»", "")
            })
        
        df = pd.DataFrame(df_list)
        
        st.success(f"âœ… å…±æœ‰ {len(df)} æ¡è®°å½•")
        
        # ç»Ÿè®¡æ¦‚è§ˆ
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("æ€»å±€æ•°", len(df))
        with col2:
            survived = len(df[df["æ’¤ç¦»"] == "âœ…"])
            st.metric("å­˜æ´»ç‡", f"{survived/len(df)*100:.1f}%")
        with col3:
            st.metric("æ€»æ”¶ç›Š", f"{df['ä»·å€¼'].sum():,}")
        with col4:
            st.metric("åœºå‡æ”¶ç›Š", f"{df['ä»·å€¼'].mean():,.0f}")
        
        st.markdown("---")
        
        # åœ°å›¾åˆ†å¸ƒ
        col1, col2 = st.columns(2)
        with col1:
            fig_map = px.pie(df, names="åœ°å›¾", title="åœ°å›¾æ¸¸ç©åˆ†å¸ƒ")
            fig_map.update_layout(paper_bgcolor='rgba(0,0,0,0)', font_color='white')
            st.plotly_chart(fig_map, use_container_width=True)
        
        with col2:
            fig_mode = px.pie(df, names="æ¨¡å¼", title="æ¨¡å¼åˆ†å¸ƒ")
            fig_mode.update_layout(paper_bgcolor='rgba(0,0,0,0)', font_color='white')
            st.plotly_chart(fig_mode, use_container_width=True)
        
        # è¯¦ç»†è®°å½•
        st.markdown("### ğŸ“‹ è¯¦ç»†è®°å½•")
        st.dataframe(df, use_container_width=True, hide_index=True)
        
        # å¯¼å‡ºåŠŸèƒ½
        st.markdown("---")
        csv = df.to_csv(index=False, encoding='utf-8-sig').encode('utf-8-sig')
        st.download_button(
            "ğŸ“¥ å¯¼å‡ºä¸ºCSV",
            csv,
            "game_records.csv",
            "text/csv",
            key='download-csv'
        )
    else:
        st.info("ğŸ“ æš‚æ— æ¸¸æˆè®°å½•")
        st.markdown("""
        **å¦‚ä½•æ·»åŠ è®°å½•ï¼Ÿ**
        
        **æ–¹å¼ä¸€ï¼šä½¿ç”¨æ¡Œé¢å®¢æˆ·ç«¯ï¼ˆæ¨èï¼‰**
        1. å¯åŠ¨æ¡Œé¢å®¢æˆ·ç«¯ (desktop/main.py)
        2. è‡ªåŠ¨è¯†åˆ«æ¸¸æˆå¹¶è®°å½•æ•°æ®
        3. æ•°æ®ä¼šè‡ªåŠ¨æ˜¾ç¤ºåœ¨è¿™é‡Œ
        
        **æ–¹å¼äºŒï¼šæ‰‹åŠ¨å½•å…¥**
        - å‰å¾€ **ğŸ“ˆ æ•°æ®ç®¡ç†** é¡µé¢æ‰‹åŠ¨æ·»åŠ è®°å½•
        
        **æ–¹å¼ä¸‰ï¼šä¸Šä¼ CSVæ–‡ä»¶**
        - å‰å¾€ **ğŸ“ˆ æ•°æ®ç®¡ç†** é¡µé¢ä¸Šä¼ CSVæ–‡ä»¶
        """)

# ==================== æ·±åº¦åˆ†ææ¨¡å— ====================
elif menu == "ğŸ“‰ æ·±åº¦åˆ†æ":
    st.title("ğŸ“‰ æ·±åº¦æ•°æ®åˆ†æ")
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
    if 'game_records' not in st.session_state or not st.session_state.game_records:
        st.warning("âš ï¸ æš‚æ— æ¸¸æˆè®°å½•ï¼Œè¯·å…ˆåœ¨ã€Œæ•°æ®ç®¡ç†ã€ä¸­æ·»åŠ è®°å½•æˆ–ä½¿ç”¨æ¡Œé¢å®¢æˆ·ç«¯")
        
        # ç”Ÿæˆç¤ºä¾‹æ•°æ®æŒ‰é’®
        st.markdown("---")
        st.markdown("### ğŸ® ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®è¿›è¡Œä½“éªŒ")
        if st.button("ç”Ÿæˆ50æ¡æ¨¡æ‹Ÿæ•°æ®", type="primary"):
            st.session_state.game_records = []
            for i in range(50):
                map_name = random.choice(MAP_LIST)
                mode = random.choice(MAP_MODES[map_name])
                zone = random.choice(MAPS_DATA[map_name]["loot_zones"])
                survived = random.random() > 0.35
                items = ["é«˜çº§æ­¦å™¨", "ä¸­çº§æ­¦å™¨", "ä½çº§æ­¦å™¨", "åŒ»ç–—åŒ…", "å¼¹è¯", "é’¥åŒ™å¡", "æƒ…æŠ¥æ–‡ä»¶"]
                item = random.choice(items)
                value = random.randint(5000, 500000) if survived else 0
                
                # æ¨¡æ‹Ÿè¿‡å»30å¤©çš„æ•°æ®
                days_ago = random.randint(0, 30)
                record_date = (datetime.now() - timedelta(days=days_ago)).strftime("%Y-%m-%d %H:%M")
                
                st.session_state.game_records.append({
                    "æ—¥æœŸ": record_date,
                    "åœ°å›¾": map_name,
                    "æ¨¡å¼": mode,
                    "åˆ·æ–°ç‚¹": zone,
                    "ç‰©èµ„": item,
                    "ä»·å€¼": value,
                    "æ’¤ç¦»": "âœ…" if survived else "âŒ"
                })
            st.session_state.total_games = 50
            st.session_state.total_profit = sum(r["ä»·å€¼"] for r in st.session_state.game_records if r["æ’¤ç¦»"] == "âœ…")
            st.success("âœ… å·²ç”Ÿæˆ50æ¡æ¨¡æ‹Ÿæ•°æ®ï¼")
            st.rerun()
    else:
        df = pd.DataFrame(st.session_state.game_records)
        df["æ—¥æœŸæ—¶é—´"] = pd.to_datetime(df["æ—¥æœŸ"], format='mixed', errors='coerce')
        df["æ—¥æœŸ_only"] = df["æ—¥æœŸæ—¶é—´"].dt.date
        
        # é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
        st.markdown("### ğŸ“Š ç»¼åˆç»Ÿè®¡æ¦‚è§ˆ")
        col1, col2, col3, col4, col5 = st.columns(5)
        
        total_games = len(df)
        survived_count = len(df[df["æ’¤ç¦»"] == "âœ…"])
        survival_rate = survived_count / total_games * 100 if total_games > 0 else 0
        total_profit = df["ä»·å€¼"].sum()
        avg_profit = df["ä»·å€¼"].mean()
        max_profit = df["ä»·å€¼"].max()
        
        with col1:
            st.metric("ğŸ® æ€»å±€æ•°", total_games)
        with col2:
            st.metric("âœ… å­˜æ´»ç‡", f"{survival_rate:.1f}%")
        with col3:
            st.metric("ğŸ’° æ€»æ”¶ç›Š", f"{total_profit:,.0f}")
        with col4:
            st.metric("ğŸ“ˆ åœºå‡æ”¶ç›Š", f"{avg_profit:,.0f}")
        with col5:
            st.metric("ğŸ† æœ€é«˜å•å±€", f"{max_profit:,.0f}")
        
        st.markdown("---")
        
        # åˆ†ææ ‡ç­¾é¡µ
        tab1, tab2, tab3, tab4 = st.tabs(["ğŸ“ˆ è¶‹åŠ¿åˆ†æ", "ğŸ—ºï¸ åœ°å›¾åˆ†æ", "ğŸ¯ æ¨¡å¼åˆ†æ", "ğŸ’ æ”¶ç›Šåˆ†æ"])
        
        with tab1:
            st.markdown("### ğŸ“ˆ å†å²è¶‹åŠ¿åˆ†æ")
            
            # æŒ‰æ—¥æœŸèšåˆ
            daily_stats = df.groupby("æ—¥æœŸ_only").agg({
                "ä»·å€¼": ["sum", "mean", "count"],
                "æ’¤ç¦»": lambda x: (x == "âœ…").sum() / len(x) * 100
            }).reset_index()
            daily_stats.columns = ["æ—¥æœŸ", "æ€»æ”¶ç›Š", "åœºå‡æ”¶ç›Š", "å±€æ•°", "å­˜æ´»ç‡"]
            
            # æ”¶ç›Šè¶‹åŠ¿å›¾
            fig_trend = go.Figure()
            fig_trend.add_trace(go.Scatter(
                x=daily_stats["æ—¥æœŸ"], y=daily_stats["æ€»æ”¶ç›Š"],
                mode='lines+markers', name='æ¯æ—¥æ€»æ”¶ç›Š',
                line=dict(color='#FFD700', width=2),
                marker=dict(size=8)
            ))
            fig_trend.update_layout(
                title="æ¯æ—¥æ”¶ç›Šè¶‹åŠ¿",
                xaxis_title="æ—¥æœŸ", yaxis_title="æ”¶ç›Š (å“ˆå¤«å¸)",
                paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                font_color='white'
            )
            st.plotly_chart(fig_trend, use_container_width=True)
            
            # å­˜æ´»ç‡è¶‹åŠ¿
            col1, col2 = st.columns(2)
            with col1:
                fig_survival = go.Figure()
                fig_survival.add_trace(go.Scatter(
                    x=daily_stats["æ—¥æœŸ"], y=daily_stats["å­˜æ´»ç‡"],
                    mode='lines+markers', name='å­˜æ´»ç‡',
                    line=dict(color='#00FF00', width=2),
                    fill='tozeroy', fillcolor='rgba(0,255,0,0.1)'
                ))
                fig_survival.update_layout(
                    title="æ¯æ—¥å­˜æ´»ç‡è¶‹åŠ¿", yaxis_title="å­˜æ´»ç‡ (%)",
                    paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                    font_color='white'
                )
                st.plotly_chart(fig_survival, use_container_width=True)
            
            with col2:
                fig_games = go.Figure()
                fig_games.add_trace(go.Bar(
                    x=daily_stats["æ—¥æœŸ"], y=daily_stats["å±€æ•°"],
                    marker_color='#4169E1', name='æ¯æ—¥å±€æ•°'
                ))
                fig_games.update_layout(
                    title="æ¯æ—¥æ¸¸æˆå±€æ•°", yaxis_title="å±€æ•°",
                    paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                    font_color='white'
                )
                st.plotly_chart(fig_games, use_container_width=True)
            
            # ç´¯è®¡æ”¶ç›Šæ›²çº¿
            df_sorted = df.sort_values("æ—¥æœŸæ—¶é—´")
            df_sorted["ç´¯è®¡æ”¶ç›Š"] = df_sorted["ä»·å€¼"].cumsum()
            
            fig_cumulative = go.Figure()
            fig_cumulative.add_trace(go.Scatter(
                x=list(range(1, len(df_sorted)+1)), y=df_sorted["ç´¯è®¡æ”¶ç›Š"],
                mode='lines', name='ç´¯è®¡æ”¶ç›Š',
                line=dict(color='#FF6B6B', width=3),
                fill='tozeroy', fillcolor='rgba(255,107,107,0.2)'
            ))
            fig_cumulative.update_layout(
                title="ç´¯è®¡æ”¶ç›Šæ›²çº¿",
                xaxis_title="æ¸¸æˆå±€æ•°", yaxis_title="ç´¯è®¡æ”¶ç›Š (å“ˆå¤«å¸)",
                paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                font_color='white'
            )
            st.plotly_chart(fig_cumulative, use_container_width=True)
        
        with tab2:
            st.markdown("### ğŸ—ºï¸ åœ°å›¾æ·±åº¦åˆ†æ")
            
            # åœ°å›¾ç»Ÿè®¡
            map_stats = df.groupby("åœ°å›¾").agg({
                "ä»·å€¼": ["sum", "mean", "count"],
                "æ’¤ç¦»": lambda x: (x == "âœ…").sum() / len(x) * 100
            }).reset_index()
            map_stats.columns = ["åœ°å›¾", "æ€»æ”¶ç›Š", "åœºå‡æ”¶ç›Š", "å±€æ•°", "å­˜æ´»ç‡"]
            map_stats = map_stats.sort_values("æ€»æ”¶ç›Š", ascending=False)
            
            col1, col2 = st.columns(2)
            
            with col1:
                # åœ°å›¾æ”¶ç›Šå¯¹æ¯”
                fig_map_profit = px.bar(
                    map_stats, x="åœ°å›¾", y="æ€»æ”¶ç›Š",
                    color="æ€»æ”¶ç›Š", color_continuous_scale="Viridis",
                    title="å„åœ°å›¾æ€»æ”¶ç›Šå¯¹æ¯”"
                )
                fig_map_profit.update_layout(
                    paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                    font_color='white'
                )
                st.plotly_chart(fig_map_profit, use_container_width=True)
            
            with col2:
                # åœ°å›¾å­˜æ´»ç‡å¯¹æ¯”
                fig_map_survival = px.bar(
                    map_stats, x="åœ°å›¾", y="å­˜æ´»ç‡",
                    color="å­˜æ´»ç‡", color_continuous_scale="RdYlGn",
                    title="å„åœ°å›¾å­˜æ´»ç‡å¯¹æ¯”"
                )
                fig_map_survival.update_layout(
                    paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                    font_color='white'
                )
                st.plotly_chart(fig_map_survival, use_container_width=True)
            
            # åœ°å›¾é›·è¾¾å›¾
            categories = ["æ€»æ”¶ç›Š", "åœºå‡æ”¶ç›Š", "å±€æ•°", "å­˜æ´»ç‡"]
            fig_radar = go.Figure()
            
            for _, row in map_stats.iterrows():
                values = [
                    row["æ€»æ”¶ç›Š"] / map_stats["æ€»æ”¶ç›Š"].max() * 100,
                    row["åœºå‡æ”¶ç›Š"] / map_stats["åœºå‡æ”¶ç›Š"].max() * 100,
                    row["å±€æ•°"] / map_stats["å±€æ•°"].max() * 100,
                    row["å­˜æ´»ç‡"]
                ]
                fig_radar.add_trace(go.Scatterpolar(
                    r=values + [values[0]],
                    theta=categories + [categories[0]],
                    name=row["åœ°å›¾"],
                    fill='toself', opacity=0.6
                ))
            
            fig_radar.update_layout(
                polar=dict(radialaxis=dict(visible=True, range=[0, 100])),
                title="åœ°å›¾ç»¼åˆèƒ½åŠ›é›·è¾¾å›¾",
                paper_bgcolor='rgba(0,0,0,0)', font_color='white'
            )
            st.plotly_chart(fig_radar, use_container_width=True)
            
            # åœ°å›¾è¯¦ç»†æ•°æ®è¡¨
            st.markdown("### ğŸ“‹ åœ°å›¾è¯¦ç»†æ•°æ®")
            map_stats_display = map_stats.copy()
            map_stats_display["æ€»æ”¶ç›Š"] = map_stats_display["æ€»æ”¶ç›Š"].apply(lambda x: f"{x:,.0f}")
            map_stats_display["åœºå‡æ”¶ç›Š"] = map_stats_display["åœºå‡æ”¶ç›Š"].apply(lambda x: f"{x:,.0f}")
            map_stats_display["å­˜æ´»ç‡"] = map_stats_display["å­˜æ´»ç‡"].apply(lambda x: f"{x:.1f}%")
            st.dataframe(map_stats_display, use_container_width=True, hide_index=True)
        
        with tab3:
            st.markdown("### ğŸ¯ æ¨¡å¼æ·±åº¦åˆ†æ")
            
            # æ¨¡å¼ç»Ÿè®¡
            mode_stats = df.groupby("æ¨¡å¼").agg({
                "ä»·å€¼": ["sum", "mean", "count"],
                "æ’¤ç¦»": lambda x: (x == "âœ…").sum() / len(x) * 100
            }).reset_index()
            mode_stats.columns = ["æ¨¡å¼", "æ€»æ”¶ç›Š", "åœºå‡æ”¶ç›Š", "å±€æ•°", "å­˜æ´»ç‡"]
            
            col1, col2 = st.columns(2)
            
            with col1:
                fig_mode_profit = px.pie(
                    mode_stats, values="æ€»æ”¶ç›Š", names="æ¨¡å¼",
                    title="å„æ¨¡å¼æ”¶ç›Šå æ¯”", hole=0.4
                )
                fig_mode_profit.update_layout(
                    paper_bgcolor='rgba(0,0,0,0)', font_color='white'
                )
                st.plotly_chart(fig_mode_profit, use_container_width=True)
            
            with col2:
                fig_mode_bar = px.bar(
                    mode_stats, x="æ¨¡å¼", y=["æ€»æ”¶ç›Š", "åœºå‡æ”¶ç›Š"],
                    barmode="group", title="æ¨¡å¼æ”¶ç›Šå¯¹æ¯”"
                )
                fig_mode_bar.update_layout(
                    paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                    font_color='white'
                )
                st.plotly_chart(fig_mode_bar, use_container_width=True)
            
            # åœ°å›¾+æ¨¡å¼ç»„åˆåˆ†æ
            st.markdown("### ğŸ”— åœ°å›¾+æ¨¡å¼ç»„åˆåˆ†æ")
            combo_stats = df.groupby(["åœ°å›¾", "æ¨¡å¼"]).agg({
                "ä»·å€¼": ["sum", "mean", "count"],
                "æ’¤ç¦»": lambda x: (x == "âœ…").sum() / len(x) * 100
            }).reset_index()
            combo_stats.columns = ["åœ°å›¾", "æ¨¡å¼", "æ€»æ”¶ç›Š", "åœºå‡æ”¶ç›Š", "å±€æ•°", "å­˜æ´»ç‡"]
            
            # çƒ­åŠ›å›¾
            pivot_profit = df.pivot_table(values="ä»·å€¼", index="åœ°å›¾", columns="æ¨¡å¼", aggfunc="mean", fill_value=0)
            
            fig_heatmap = px.imshow(
                pivot_profit, text_auto=".0f",
                color_continuous_scale="YlOrRd",
                title="åœ°å›¾+æ¨¡å¼åœºå‡æ”¶ç›Šçƒ­åŠ›å›¾"
            )
            fig_heatmap.update_layout(
                paper_bgcolor='rgba(0,0,0,0)', font_color='white'
            )
            st.plotly_chart(fig_heatmap, use_container_width=True)
            
            # ç»„åˆæ’è¡Œæ¦œ
            combo_stats_sorted = combo_stats.sort_values("åœºå‡æ”¶ç›Š", ascending=False)
            st.markdown("### ğŸ† æœ€ä½³ç»„åˆæ’è¡Œ")
            for i, (_, row) in enumerate(combo_stats_sorted.head(5).iterrows()):
                medal = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰", "4ï¸âƒ£", "5ï¸âƒ£"][i]
                st.markdown(f"{medal} **{row['åœ°å›¾']} - {row['æ¨¡å¼']}**: åœºå‡ {row['åœºå‡æ”¶ç›Š']:,.0f} | å­˜æ´»ç‡ {row['å­˜æ´»ç‡']:.1f}% | å±€æ•° {row['å±€æ•°']}")
        
        with tab4:
            st.markdown("### ğŸ’ æ”¶ç›Šæ·±åº¦åˆ†æ")
            
            # æ”¶ç›Šåˆ†å¸ƒç›´æ–¹å›¾
            fig_dist = px.histogram(
                df[df["ä»·å€¼"] > 0], x="ä»·å€¼", nbins=30,
                title="æ”¶ç›Šåˆ†å¸ƒ (ä»…æˆåŠŸæ’¤ç¦»)",
                color_discrete_sequence=["#FFD700"]
            )
            fig_dist.update_layout(
                paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                font_color='white', xaxis_title="æ”¶ç›Š (å“ˆå¤«å¸)", yaxis_title="é¢‘æ¬¡"
            )
            st.plotly_chart(fig_dist, use_container_width=True)
            
            col1, col2 = st.columns(2)
            
            with col1:
                # æ”¶ç›ŠåŒºé—´ç»Ÿè®¡
                df_survived = df[df["æ’¤ç¦»"] == "âœ…"]
                bins = [0, 50000, 100000, 200000, 500000, float('inf')]
                labels = ["0-5ä¸‡", "5-10ä¸‡", "10-20ä¸‡", "20-50ä¸‡", "50ä¸‡+"]
                df_survived["æ”¶ç›ŠåŒºé—´"] = pd.cut(df_survived["ä»·å€¼"], bins=bins, labels=labels)
                
                range_stats = df_survived["æ”¶ç›ŠåŒºé—´"].value_counts().sort_index()
                fig_range = px.pie(
                    names=range_stats.index, values=range_stats.values,
                    title="æ”¶ç›ŠåŒºé—´åˆ†å¸ƒ", hole=0.3
                )
                fig_range.update_layout(paper_bgcolor='rgba(0,0,0,0)', font_color='white')
                st.plotly_chart(fig_range, use_container_width=True)
            
            with col2:
                # ç‰©èµ„æ”¶ç›Šæ’è¡Œ
                item_stats = df.groupby("ç‰©èµ„")["ä»·å€¼"].agg(["sum", "mean", "count"]).reset_index()
                item_stats.columns = ["ç‰©èµ„", "æ€»æ”¶ç›Š", "å¹³å‡ä»·å€¼", "è·å–æ¬¡æ•°"]
                item_stats = item_stats.sort_values("æ€»æ”¶ç›Š", ascending=False).head(10)
                
                fig_items = px.bar(
                    item_stats, y="ç‰©èµ„", x="æ€»æ”¶ç›Š", orientation='h',
                    title="ç‰©èµ„æ”¶ç›Šæ’è¡ŒTOP10", color="æ€»æ”¶ç›Š",
                    color_continuous_scale="Viridis"
                )
                fig_items.update_layout(
                    paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                    font_color='white'
                )
                st.plotly_chart(fig_items, use_container_width=True)
            
            # é£é™©æ”¶ç›Šåˆ†æ
            st.markdown("### âš–ï¸ é£é™©æ”¶ç›Šåˆ†æ")
            risk_data = []
            for mode in df["æ¨¡å¼"].unique():
                mode_df = df[df["æ¨¡å¼"] == mode]
                survival = (mode_df["æ’¤ç¦»"] == "âœ…").mean() * 100
                avg_profit = mode_df[mode_df["æ’¤ç¦»"] == "âœ…"]["ä»·å€¼"].mean() if len(mode_df[mode_df["æ’¤ç¦»"] == "âœ…"]) > 0 else 0
                expected_value = survival / 100 * avg_profit
                risk_data.append({
                    "æ¨¡å¼": mode,
                    "å­˜æ´»ç‡": survival,
                    "æˆåŠŸåœºå‡": avg_profit,
                    "æœŸæœ›æ”¶ç›Š": expected_value
                })
            
            risk_df = pd.DataFrame(risk_data)
            fig_risk = px.scatter(
                risk_df, x="å­˜æ´»ç‡", y="æˆåŠŸåœºå‡", size="æœŸæœ›æ”¶ç›Š",
                color="æ¨¡å¼", title="é£é™©æ”¶ç›Šæ•£ç‚¹å›¾ (æ°”æ³¡å¤§å°=æœŸæœ›æ”¶ç›Š)",
                size_max=50
            )
            fig_risk.update_layout(
                paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)',
                font_color='white', xaxis_title="å­˜æ´»ç‡ (%)", yaxis_title="æˆåŠŸåœºå‡æ”¶ç›Š"
            )
            st.plotly_chart(fig_risk, use_container_width=True)
            
            st.dataframe(risk_df.round(1), use_container_width=True, hide_index=True)

# ==================== æ™ºèƒ½æ¨èæ¨¡å— ====================
elif menu == "ğŸ¤– æ™ºèƒ½æ¨è":
    st.title("ğŸ¤– æ™ºèƒ½æ¨èç³»ç»Ÿ")
    
    st.markdown("""
    åŸºäºæ‚¨çš„å†å²æ¸¸æˆæ•°æ®ï¼ŒAIç³»ç»Ÿä¼šåˆ†ææ‚¨çš„æ¸¸æˆé£æ ¼ï¼Œ
    å¹¶æ¨èæœ€é€‚åˆæ‚¨çš„åœ°å›¾ã€æ¨¡å¼å’Œè£…å¤‡é…ç½®ã€‚
    """)
    
    if 'game_records' not in st.session_state or not st.session_state.game_records or len(st.session_state.game_records) < 5:
        st.warning("âš ï¸ éœ€è¦è‡³å°‘5æ¡æ¸¸æˆè®°å½•æ‰èƒ½è¿›è¡Œæ™ºèƒ½åˆ†æ")
        st.info("ğŸ’¡ è¯·å‰å¾€ã€Œæ•°æ®ç®¡ç†ã€æ·»åŠ è®°å½•ï¼Œæˆ–åœ¨ã€Œæ·±åº¦åˆ†æã€é¡µé¢ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®")
    else:
        df = pd.DataFrame(st.session_state.game_records)
        
        # ç©å®¶ç”»åƒåˆ†æ
        st.markdown("---")
        st.markdown("## ğŸ­ ç©å®¶ç”»åƒåˆ†æ")
        
        total_games = len(df)
        survived = len(df[df["æ’¤ç¦»"] == "âœ…"])
        survival_rate = survived / total_games * 100
        avg_profit = df["ä»·å€¼"].mean()
        
        # è®¡ç®—ç©å®¶ç±»å‹
        player_type = ""
        player_desc = ""
        player_color = ""
        
        if survival_rate >= 70:
            if avg_profit >= 200000:
                player_type = "ğŸ† ç²¾è‹±çŒäºº"
                player_desc = "é«˜å­˜æ´»ã€é«˜æ”¶ç›Šï¼Œæ˜¯é¡¶çº§ç©å®¶ï¼"
                player_color = "#FFD700"
            else:
                player_type = "ğŸ›¡ï¸ ç¨³å¥ç©å®¶"
                player_desc = "å­˜æ´»ç‡æé«˜ï¼Œå»ºè®®å°è¯•æ›´é«˜éš¾åº¦åœ°å›¾æå‡æ”¶ç›Š"
                player_color = "#4169E1"
        elif survival_rate >= 50:
            if avg_profit >= 150000:
                player_type = "âš”ï¸ å†’é™©å®¶"
                player_desc = "æ•¢äºå†’é™©ï¼Œæ”¶ç›Šä¸é”™ï¼æé«˜å­˜æ´»ç‡å¯æ›´è¿›ä¸€æ­¥"
                player_color = "#FF6B6B"
            else:
                player_type = "ğŸ“ˆ æˆé•¿å‹"
                player_desc = "å„æ–¹é¢å‡è¡¡ï¼Œç»§ç»­ç§¯ç´¯ç»éªŒ"
                player_color = "#32CD32"
        else:
            if avg_profit >= 100000:
                player_type = "ğŸ’€ é«˜é£é™©ç©å®¶"
                player_desc = "æ”¶ç›Šä¸é”™ä½†å­˜æ´»ç‡åä½ï¼Œå»ºè®®æå‡ç”Ÿå­˜æŠ€å·§"
                player_color = "#DC143C"
            else:
                player_type = "ğŸŒ± æ–°æ‰‹æ¢ç´¢è€…"
                player_desc = "è¿˜åœ¨å­¦ä¹ é˜¶æ®µï¼Œå»ºè®®ä»æ™®é€šæ¨¡å¼å¼€å§‹"
                player_color = "#90EE90"
        
        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            st.markdown(f"""
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                        padding: 2rem; border-radius: 20px; text-align: center;
                        border: 2px solid {player_color};">
                <h1 style="color: {player_color}; margin: 0;">{player_type}</h1>
                <p style="color: #ccc; font-size: 1.2rem; margin-top: 10px;">{player_desc}</p>
                <hr style="border-color: #333;">
                <div style="display: flex; justify-content: space-around; margin-top: 1rem;">
                    <div>
                        <p style="color: #888; margin: 0;">å­˜æ´»ç‡</p>
                        <h2 style="color: #fff; margin: 0;">{survival_rate:.1f}%</h2>
                    </div>
                    <div>
                        <p style="color: #888; margin: 0;">åœºå‡æ”¶ç›Š</p>
                        <h2 style="color: #fff; margin: 0;">{avg_profit:,.0f}</h2>
                    </div>
                    <div>
                        <p style="color: #888; margin: 0;">æ€»å±€æ•°</p>
                        <h2 style="color: #fff; margin: 0;">{total_games}</h2>
                    </div>
                </div>
            </div>
            """, unsafe_allow_html=True)
        
        st.markdown("---")
        
        # æ™ºèƒ½æ¨è
        st.markdown("## ğŸ¯ ä¸ªæ€§åŒ–æ¨è")
        
        # è®¡ç®—å„åœ°å›¾å’Œæ¨¡å¼çš„è¡¨ç°
        map_performance = df.groupby("åœ°å›¾").agg({
            "ä»·å€¼": "mean",
            "æ’¤ç¦»": lambda x: (x == "âœ…").sum() / len(x) * 100
        }).reset_index()
        map_performance.columns = ["åœ°å›¾", "åœºå‡æ”¶ç›Š", "å­˜æ´»ç‡"]
        map_performance["ç»¼åˆå¾—åˆ†"] = map_performance["åœºå‡æ”¶ç›Š"] / 1000 + map_performance["å­˜æ´»ç‡"] * 2
        
        mode_performance = df.groupby("æ¨¡å¼").agg({
            "ä»·å€¼": "mean",
            "æ’¤ç¦»": lambda x: (x == "âœ…").sum() / len(x) * 100
        }).reset_index()
        mode_performance.columns = ["æ¨¡å¼", "åœºå‡æ”¶ç›Š", "å­˜æ´»ç‡"]
        
        # æœ€ä½³åœ°å›¾æ¨è
        best_map = map_performance.loc[map_performance["ç»¼åˆå¾—åˆ†"].idxmax()]
        
        # åŸºäºç©å®¶é£æ ¼æ¨èæ¨¡å¼
        if survival_rate >= 60:
            recommended_mode = "æœºå¯†" if survival_rate < 75 else "ç»å¯†"
            mode_reason = "æ‚¨çš„å­˜æ´»ç‡è¾ƒé«˜ï¼Œå¯ä»¥æŒ‘æˆ˜æ›´é«˜éš¾åº¦ä»¥è·å–æ›´å¤šæ”¶ç›Š"
        else:
            recommended_mode = "æ™®é€š"
            mode_reason = "å»ºè®®å…ˆåœ¨æ™®é€šæ¨¡å¼æå‡æŠ€æœ¯ï¼Œå†æŒ‘æˆ˜é«˜éš¾åº¦"
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("### ğŸ—ºï¸ æ¨èåœ°å›¾")
            st.success(f"**{best_map['åœ°å›¾']}**")
            st.markdown(f"""
            - ğŸ“Š æ‚¨çš„åœºå‡æ”¶ç›Š: **{best_map['åœºå‡æ”¶ç›Š']:,.0f}**
            - âœ… æ‚¨çš„å­˜æ´»ç‡: **{best_map['å­˜æ´»ç‡']:.1f}%**
            - ğŸ’¡ æ¨èç†ç”±: æ ¹æ®æ‚¨çš„å†å²æ•°æ®ï¼Œè¿™å¼ åœ°å›¾æ˜¯æ‚¨è¡¨ç°æœ€å¥½çš„
            """)
            
            # è¯¥åœ°å›¾çš„è£…å¤‡æ¨è
            st.markdown("#### ğŸ’ æ¨èè£…å¤‡")
            rec = LOADOUT_RECOMMENDATIONS[best_map['åœ°å›¾']]
            st.markdown(f"- ä¸»æ­¦å™¨: {', '.join(rec['ä¸»æ­¦å™¨'])}")
            st.markdown(f"- å‰¯æ­¦å™¨: {', '.join(rec['å‰¯æ­¦å™¨'])}")
            st.markdown(f"- é…ä»¶: {', '.join(rec['æ¨èé…ä»¶'])}")
        
        with col2:
            st.markdown("### ğŸ¯ æ¨èæ¨¡å¼")
            st.success(f"**{recommended_mode}**")
            st.markdown(f"""
            - ğŸ’¡ æ¨èç†ç”±: {mode_reason}
            - âš ï¸ é£é™©ç­‰çº§: **{MODE_LOADOUT[recommended_mode]['é£é™©ç­‰çº§']}**
            - ğŸ’° é¢„ä¼°æˆæœ¬: **{MODE_LOADOUT[recommended_mode]['é¢„ä¼°æˆæœ¬']:,}**
            - ğŸ›¡ï¸ æ¨èæŠ¤ç”²: {MODE_LOADOUT[recommended_mode]['æ¨èæŠ¤ç”²']}
            """)
        
        st.markdown("---")
        
        # æå‡å»ºè®®
        st.markdown("## ğŸ’¡ æå‡å»ºè®®")
        
        suggestions = []
        
        # å­˜æ´»ç‡å»ºè®®
        if survival_rate < 50:
            suggestions.append({
                "icon": "ğŸ›¡ï¸",
                "title": "æå‡å­˜æ´»ç‡",
                "content": "æ‚¨çš„å­˜æ´»ç‡åä½ï¼Œå»ºè®®: 1) é€‰æ‹©æ›´é«˜çº§çš„æŠ¤ç”² 2) å¤šå¸¦åŒ»ç–—ç‰©èµ„ 3) å­¦ä¹ åœ°å›¾æ’¤ç¦»ç‚¹ä½ç½® 4) é¿å¼€çƒ­é—¨åŒºåŸŸ"
            })
        
        # æ”¶ç›Šå»ºè®®
        if avg_profit < 100000:
            suggestions.append({
                "icon": "ğŸ’°",
                "title": "æå‡æ”¶ç›Š",
                "content": "åœºå‡æ”¶ç›Šåä½ï¼Œå»ºè®®: 1) ç†Ÿæ‚‰é«˜ä»·å€¼ç‰©èµ„åˆ·æ–°ç‚¹ 2) æºå¸¦è¶³å¤Ÿç©ºé—´çš„èƒŒåŒ… 3) ä¼˜å…ˆæœç´¢çƒ­é—¨åŒºåŸŸ 4) å°è¯•æœºå¯†/ç»å¯†æ¨¡å¼"
            })
        
        # åœ°å›¾å¤šæ ·æ€§
        maps_played = df["åœ°å›¾"].nunique()
        if maps_played < 3:
            suggestions.append({
                "icon": "ğŸ—ºï¸",
                "title": "æ¢ç´¢æ›´å¤šåœ°å›¾",
                "content": f"æ‚¨åªç©è¿‡{maps_played}å¼ åœ°å›¾ï¼Œå»ºè®®å°è¯•å…¶ä»–åœ°å›¾ï¼Œä¸åŒåœ°å›¾æœ‰ä¸åŒçš„ç­–ç•¥å’Œæ”¶ç›Šç‰¹ç‚¹"
            })
        
        # æ¨¡å¼å¤šæ ·æ€§
        modes_played = df["æ¨¡å¼"].nunique()
        if modes_played < 2:
            suggestions.append({
                "icon": "ğŸ¯",
                "title": "å°è¯•ä¸åŒæ¨¡å¼",
                "content": "å»ºè®®å°è¯•ä¸åŒéš¾åº¦æ¨¡å¼ï¼Œç§¯ç´¯ç»éªŒåé€æ­¥æŒ‘æˆ˜æ›´é«˜éš¾åº¦"
            })
        
        if not suggestions:
            suggestions.append({
                "icon": "ğŸ†",
                "title": "è¡¨ç°ä¼˜ç§€",
                "content": "æ‚¨çš„æ•°æ®è¡¨ç°éå¸¸å¥½ï¼ç»§ç»­ä¿æŒï¼ŒæŒ‘æˆ˜æ›´é«˜éš¾åº¦è·å–æ›´å¤šæ”¶ç›Š"
            })
        
        for s in suggestions:
            st.markdown(f"""
            <div style="background: #1e1e2e; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid #FFD700;">
                <h4 style="margin: 0;">{s['icon']} {s['title']}</h4>
                <p style="color: #ccc; margin: 0.5rem 0 0 0;">{s['content']}</p>
            </div>
            """, unsafe_allow_html=True)
        
        st.markdown("---")
        
        # é¢„æµ‹ä¸‹ä¸€å±€
        st.markdown("## ğŸ”® ä¸‹ä¸€å±€é¢„æµ‹")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            pred_map = st.selectbox("é€‰æ‹©åœ°å›¾", MAP_LIST, key="pred_map")
        with col2:
            pred_modes = MAP_MODES[pred_map]
            pred_mode = st.selectbox("é€‰æ‹©æ¨¡å¼", pred_modes, key="pred_mode")
        with col3:
            st.markdown("&nbsp;")  # å ä½
            if st.button("ğŸ”® é¢„æµ‹ç»“æœ", type="primary"):
                # åŸºäºå†å²æ•°æ®é¢„æµ‹
                similar_games = df[(df["åœ°å›¾"] == pred_map) & (df["æ¨¡å¼"] == pred_mode)]
                
                if len(similar_games) >= 3:
                    pred_survival = (similar_games["æ’¤ç¦»"] == "âœ…").mean() * 100
                    pred_profit = similar_games[similar_games["æ’¤ç¦»"] == "âœ…"]["ä»·å€¼"].mean() if len(similar_games[similar_games["æ’¤ç¦»"] == "âœ…"]) > 0 else 0
                    confidence = min(len(similar_games) * 10, 90)
                else:
                    # ä½¿ç”¨é»˜è®¤æ•°æ®
                    mode_info = MODE_INFO[pred_mode]
                    pred_survival = 50 / mode_info["loot_modifier"]
                    pred_profit = 100000 * mode_info["loot_modifier"]
                    confidence = 30
                
                st.markdown(f"""
                <div style="background: linear-gradient(135deg, #2d2d44 0%, #1a1a2e 100%); 
                            padding: 1.5rem; border-radius: 15px; margin-top: 1rem;">
                    <h3 style="color: #FFD700; text-align: center;">ğŸ”® é¢„æµ‹ç»“æœ</h3>
                    <div style="display: flex; justify-content: space-around; margin-top: 1rem;">
                        <div style="text-align: center;">
                            <p style="color: #888; margin: 0;">é¢„æµ‹å­˜æ´»ç‡</p>
                            <h2 style="color: #00FF00; margin: 0;">{pred_survival:.1f}%</h2>
                        </div>
                        <div style="text-align: center;">
                            <p style="color: #888; margin: 0;">é¢„æœŸæ”¶ç›Š</p>
                            <h2 style="color: #FFD700; margin: 0;">{pred_profit:,.0f}</h2>
                        </div>
                        <div style="text-align: center;">
                            <p style="color: #888; margin: 0;">ç½®ä¿¡åº¦</p>
                            <h2 style="color: #4169E1; margin: 0;">{confidence}%</h2>
                        </div>
                    </div>
                </div>
                """, unsafe_allow_html=True)

# ==================== å®æ—¶æ¸¸æˆç›‘æ§ ====================
elif menu == "ğŸ’» å®æ—¶ç›‘æ§":
    st.title("ğŸ’» å®æ—¶æ¸¸æˆç›‘æ§ç³»ç»Ÿ")
    st.caption("è‡ªåŠ¨è¯†åˆ«å‡ºç”Ÿç‚¹å’Œé«˜ä»·å€¼ç‰©å“ | å®æ—¶è®°å½•æˆ˜å±€æ•°æ®")
    
    # æ£€æµ‹è¿è¡Œç¯å¢ƒ
    import os
    IS_CLOUD = os.getenv("STREAMLIT_SHARING_MODE") is not None or \
               os.getenv("STREAMLIT_RUNTIME_ENV") == "cloud"
    
    if IS_CLOUD:
        # äº‘ç«¯ç¯å¢ƒæç¤º
        st.warning("âš ï¸ æ¸¸æˆç›‘æ§åŠŸèƒ½ä»…æ”¯æŒæœ¬åœ°è¿è¡Œ")
        st.info("""
        **ä¸ºä»€ä¹ˆæ— æ³•ä½¿ç”¨ï¼Ÿ**
        
        æ¸¸æˆç›‘æ§éœ€è¦æ•è·æ‚¨çš„ç”µè„‘å±å¹•ï¼Œä½† Streamlit Cloud æ˜¯è¿œç¨‹æœåŠ¡å™¨ï¼Œæ— æ³•è®¿é—®æ‚¨çš„æœ¬åœ°å±å¹•ã€‚
        
        **å¦‚ä½•ä½¿ç”¨å®æ—¶ç›‘æ§ï¼Ÿ**
        
        è¯·åœ¨æ‚¨çš„ç”µè„‘ä¸Šæœ¬åœ°è¿è¡Œæ­¤åº”ç”¨:
        """)
        
        st.code("""
# 1. å…‹éš†ä»“åº“
git clone https://github.com/liu474751-tech/delta-tool.git
cd delta-tool

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. è¿è¡Œåº”ç”¨
streamlit run app.py
        """, language="bash")
        
        st.success("""
        ğŸ’¡ **æç¤º**: äº‘ç«¯ç‰ˆæœ¬çš„å…¶ä»–åŠŸèƒ½ (æˆ˜æœ¯åœ°å›¾ã€ç‰©èµ„åˆ†æã€æ•°æ®ç®¡ç†ç­‰) å®Œå…¨å¯ç”¨ï¼
        
        æ‚¨å¯ä»¥åœ¨æœ¬åœ°è®°å½•æ•°æ®åï¼Œå¯¼å‡ºCSVæ–‡ä»¶ï¼Œç„¶ååœ¨äº‘ç«¯ç‰ˆæœ¬è¿›è¡Œåˆ†æã€‚
        """)
        
        st.markdown("---")
        st.markdown("### ğŸ“¥ å¿«é€Ÿå¼€å§‹")
        
        col1, col2 = st.columns(2)
        with col1:
            st.link_button(
                "ğŸ“‚ GitHub ä»“åº“",
                "https://github.com/liu474751-tech/delta-tool",
                use_container_width=True
            )
        with col2:
            st.link_button(
                "ğŸ“¥ ä¸‹è½½ ZIP",
                "https://github.com/liu474751-tech/delta-tool/archive/refs/heads/main.zip",
                use_container_width=True
            )
        
        monitor_available = False
    else:
        # æœ¬åœ°ç¯å¢ƒï¼Œæ­£å¸¸åŠ è½½ç›‘æ§æ¨¡å—
        try:
            from game_monitor import get_monitor
            monitor = get_monitor()
            monitor_available = True
        except Exception as e:
            monitor_available = False
            st.error(f"âš ï¸ ç›‘æ§æ¨¡å—åŠ è½½å¤±è´¥: {e}")
            st.warning("è¯·å®‰è£…ä¾èµ–åº“")
            st.code("pip install opencv-python mss numpy pillow", language="bash")
    
    if monitor_available:
        # æ§åˆ¶é¢æ¿
        st.markdown("### ğŸ® ç›‘æ§æ§åˆ¶å°")
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            if st.button("â–¶ï¸ å¯åŠ¨ç›‘æ§", type="primary", use_container_width=True):
                result = monitor.start_monitoring()
                if result["status"] == "success":
                    st.success(result["message"])
                else:
                    st.error(result["message"])
        
        with col2:
            if st.button("â¸ï¸ åœæ­¢ç›‘æ§", use_container_width=True):
                result = monitor.stop_monitoring()
                st.info(result["message"])
        
        with col3:
            if st.button("âœ… æˆåŠŸæ’¤ç¦»", use_container_width=True):
                profit = st.session_state.get('temp_profit', 0)
                result = monitor.end_session(survived=True, profit=profit)
                if result["status"] == "success":
                    st.success("ä¼šè¯å·²ç»“æŸï¼æ•°æ®å·²ä¿å­˜")
        
        with col4:
            if st.button("âŒ é˜µäº¡é€€å‡º", use_container_width=True):
                result = monitor.end_session(survived=False, profit=0)
                if result["status"] == "success":
                    st.warning("ä¼šè¯å·²ç»“æŸ")
        
        # ç›‘æ§çŠ¶æ€
        current_session = monitor.get_current_session()
        is_monitoring = monitor.is_running
        
        st.markdown("---")
        if is_monitoring:
            st.success("ğŸŸ¢ **ç›‘æ§çŠ¶æ€ï¼šè¿è¡Œä¸­**")
        else:
            st.error("ğŸ”´ **ç›‘æ§çŠ¶æ€ï¼šå·²åœæ­¢**")
        
        # å½“å‰ä¼šè¯
        if current_session["active"]:
            st.markdown("## ğŸ® å½“å‰æ¸¸æˆä¼šè¯")
            
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("ğŸ¯ å‡ºç”Ÿç‚¹", current_session.get("spawn_point") or "æ£€æµ‹ä¸­...")
            with col2:
                st.metric("ğŸ—ºï¸ åœ°å›¾", current_session.get("map") or "æ£€æµ‹ä¸­...")
            with col3:
                st.metric("ğŸ“¦ æ£€æµ‹åˆ°ç‰©å“", len(current_session.get("items", [])))
            with col4:
                if current_session.get("start_time"):
                    duration = (datetime.now() - current_session["start_time"]).total_seconds() / 60
                    st.metric("â±ï¸ æ¸¸æˆæ—¶é•¿", f"{int(duration)} åˆ†é’Ÿ")
            
            st.markdown("---")
            st.markdown("### ğŸ” æ£€æµ‹åˆ°çš„é«˜ä»·å€¼ç‰©å“")
            
            items = current_session.get("items", [])
            if items:
                df_items = []
                for idx, item in enumerate(items, 1):
                    df_items.append({
                        "åºå·": idx,
                        "ç±»å‹": item["type"],
                        "æ—¶é—´": item["time"].split('T')[1][:8] if 'T' in item["time"] else item["time"],
                        "åƒç´ æ•°": item["pixel_count"],
                    })
                st.dataframe(pd.DataFrame(df_items), use_container_width=True)
            else:
                st.info("ğŸ“Œ æš‚æœªæ£€æµ‹åˆ°é«˜ä»·å€¼ç‰©å“")
            
            st.markdown("---")
            profit_input = st.number_input("æ’¤ç¦»åçš„æ€»æ”¶ç›Šï¼ˆå“ˆå¤«å¸ï¼‰", value=0, step=10000)
            st.session_state.temp_profit = profit_input
        else:
            st.info("ğŸ“Œ å½“å‰æ²¡æœ‰æ´»è·ƒçš„æ¸¸æˆä¼šè¯ï¼Œç‚¹å‡»'å¯åŠ¨ç›‘æ§'å¼€å§‹")
        
        # OCRåŠŸèƒ½çŠ¶æ€å’Œç®¡ç†
        st.markdown("---")
        st.markdown("## ğŸ” OCRè¯†åˆ«åŠŸèƒ½")
        
        try:
            from game_ocr import get_ocr_engine, install_ocr_engine, OCR_AVAILABLE, OCR_ENGINE
            data_dir = Path.home() / "Documents" / "DeltaTool"
            ocr = get_ocr_engine(data_dir)
            
            if ocr.is_available():
                st.success(f"âœ… OCRå¼•æ“å·²å°±ç»ª: {ocr.engine_type.upper()}")
                
                # æ˜¾ç¤ºè¯†åˆ«ç»Ÿè®¡
                spawn_stats = ocr.get_spawn_name_statistics()
                
                if spawn_stats:
                    st.markdown("### ğŸ“Š è¯†åˆ«åˆ°çš„å‡ºç”Ÿç‚¹åç§°")
                    
                    st.info(f"å…±è¯†åˆ«åˆ° {len(spawn_stats)} ä¸ªä¸åŒçš„å‡ºç”Ÿç‚¹")
                    
                    # åˆ›å»ºè¡¨æ ¼
                    spawn_data = []
                    for spawn_name, stats in spawn_stats.items():
                        spawn_data.append({
                            "å‡ºç”Ÿç‚¹åç§°": spawn_name,
                            "è¯†åˆ«æ¬¡æ•°": stats["count"],
                            "å¹³å‡ç½®ä¿¡åº¦": f"{stats['avg_confidence']:.2%}",
                            "é¦–æ¬¡è¯†åˆ«": stats["first_seen"][:10]  # åªæ˜¾ç¤ºæ—¥æœŸ
                        })
                    
                    st.dataframe(spawn_data, use_container_width=True, hide_index=True)
                    
                    st.markdown("### ğŸ’¡ ä½¿ç”¨è¿™äº›æ•°æ®")
                    st.info("""
                    **è¯†åˆ«åˆ°çš„å‡ºç”Ÿç‚¹åç§°å¯ä»¥ç”¨äºï¼š**
                    1. å®Œå–„æˆ˜æœ¯åœ°å›¾ä¸­çš„å‡ºç”Ÿç‚¹å‘½å
                    2. ç»Ÿè®¡æœ€å¸¸è§çš„é™è½åœ°ç‚¹
                    3. ä¼˜åŒ–å‡ºç”Ÿç‚¹åŒ¹é…ç®—æ³•
                    
                    **å¦‚ä½•æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š**
                    - æ—¥å¿—æ–‡ä»¶ä½äº: `C:\\Users\\ä½ çš„ç”¨æˆ·å\\Documents\\DeltaTool\\spawn_names_detected.json`
                    - æˆªå›¾ä¿å­˜åœ¨: `C:\\Users\\ä½ çš„ç”¨æˆ·å\\Documents\\DeltaTool\\spawn_detection_*.png`
                    """)
                    
                    # å¯¼å‡ºåŠŸèƒ½
                    if st.button("ğŸ“¥ å¯¼å‡ºå‡ºç”Ÿç‚¹æ•°æ®ä¸ºCSV"):
                        import pandas as pd
                        df = pd.DataFrame(spawn_data)
                        csv = df.to_csv(index=False, encoding='utf-8-sig')
                        st.download_button(
                            label="ä¸‹è½½ CSV",
                            data=csv,
                            file_name=f"spawn_points_detected_{datetime.now().strftime('%Y%m%d')}.csv",
                            mime="text/csv"
                        )
                else:
                    st.info("ğŸ¯ å¼€å§‹æ¸¸æˆå¹¶å¯åŠ¨ç›‘æ§ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«é™è½åœ°ç‚¹åç§°")
            
            elif OCR_AVAILABLE:
                st.warning(f"âš ï¸ OCRå¼•æ“ ({OCR_ENGINE}) å·²å®‰è£…ä½†æœªåˆå§‹åŒ–")
            else:
                st.warning("âš ï¸ OCRå¼•æ“æœªå®‰è£…")
                
                with st.expander("ğŸ“¥ å®‰è£…OCRå¼•æ“"):
                    st.markdown("""
                    **æ¨èæ–¹æ¡ˆï¼ˆäºŒé€‰ä¸€ï¼‰ï¼š**
                    
                    **1. EasyOCR** (ç®€å•æ˜“ç”¨ï¼Œæ”¯æŒä¸­è‹±æ–‡)
                    ```bash
                    pip install easyocr
                    ```
                    
                    **2. PaddleOCR** (ä¸­æ–‡è¯†åˆ«æ›´å¼º)
                    ```bash
                    pip install paddlepaddle paddleocr
                    ```
                    
                    å®‰è£…åé‡å¯åº”ç”¨å³å¯ä½¿ç”¨OCRåŠŸèƒ½ã€‚
                    """)
                    
                    st.info("""
                    **OCRåŠŸèƒ½ä½œç”¨ï¼š**
                    - ğŸ¯ è‡ªåŠ¨è¯†åˆ«é™è½åœ°ç‚¹æ–‡å­—
                    - ğŸ“Š è‡ªåŠ¨è¯†åˆ«ç»“ç®—ç”»é¢ï¼ˆæ’¤ç¦»/é˜µäº¡ã€æ”¶ç›Šï¼‰
                    - ğŸ“ è®°å½•çœŸå®çš„æ¸¸æˆä¸­æ–‡åç§°
                    - ğŸ—ºï¸ ç”¨äºå®Œå–„æˆ˜æœ¯åœ°å›¾æ•°æ®
                    """)
        
        except Exception as e:
            st.error(f"OCRæ¨¡å—åŠ è½½å¤±è´¥: {e}")

# ==================== é¡µè„š ====================
st.markdown("---")
st.markdown(
    "<p style='text-align: center; color: #666;'>ğŸ® ä¸‰è§’æ´²æˆ˜æœ¯ç»ˆç«¯ v4.0 | Built with Streamlit | æ•°æ®æ¥æº: TapTapç¤¾åŒº + ä¸ªäººç»Ÿè®¡</p>",
    unsafe_allow_html=True
)
